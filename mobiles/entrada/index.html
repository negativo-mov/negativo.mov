<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MÓBILES — entrada</title>
<style>
  :root{
    --bg:#fbf7fb;
    --ink:rgba(24,19,21,.88);
    --muted:rgba(24,19,21,.58);
    --card:rgba(255,255,255,.72);
    --stroke:rgba(24,19,21,.22);
    --stroke2:rgba(24,19,21,.34);
    --shadow:rgba(0,0,0,.10);
    --pink:rgba(255,170,210,.55);
    --blue:rgba(170,215,255,.55);
    --acid:rgba(190,255,210,.20);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:
      radial-gradient(900px 450px at 20% 10%, rgba(255,170,210,.18), transparent 60%),
      radial-gradient(900px 450px at 80% 12%, rgba(170,215,255,.18), transparent 60%),
      radial-gradient(900px 650px at 50% 90%, rgba(190,255,210,.10), transparent 55%),
      var(--bg);
    color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    line-height:1.55;
  }

  .wrap{max-width:980px; margin:0 auto; padding:28px 16px 70px}
  .top{
    display:flex; gap:16px; align-items:flex-start; justify-content:space-between;
    padding:8px 0 16px;
  }
  .title{
    font-weight:900; letter-spacing:.4px; font-size:22px;
  }
  .pill{
    font-size:12px; color:var(--muted);
    padding:8px 10px; border:1px solid var(--stroke);
    border-radius:999px; background:rgba(255,255,255,.55);
    box-shadow:0 8px 22px var(--shadow);
    white-space:nowrap;
  }

  .lead{
    margin:14px 0 26px;
    font-size:16px;
    color:rgba(24,19,21,.80);
  }
  .sig{
    margin-top:8px;
    color:rgba(24,19,21,.55);
    font-size:13px;
  }

  .section{ margin:28px 0 0; }
  .intro{
    margin: 0 0 10px;
    font-size:15px;
    color:rgba(24,19,21,.78);
    white-space:pre-line;
  }
  .canvasBox{
    margin: 10px 0 10px;
    width:100%;
    border-radius:22px;
    background:rgba(255,255,255,.60);
    border:1px solid var(--stroke);
    box-shadow: 0 20px 50px var(--shadow);
    padding:14px;
  }
  canvas{
    width:100%;
    height:auto;
    display:block;
    border-radius:18px;
    background:rgba(255,255,255,.35);
  }
  .textgen{
    margin:10px 6px 0;
    color:rgba(24,19,21,.82);
    font-size:15px;
  }

  .controls{
    display:flex; gap:10px; flex-wrap:wrap;
    margin:12px 4px 2px;
    align-items:center;
  }
  button{
    appearance:none;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.70);
    color:rgba(24,19,21,.86);
    border-radius:999px;
    padding:10px 14px;
    font-weight:700;
    cursor:pointer;
    box-shadow: 0 10px 24px var(--shadow);
    transition: transform .06s ease, background .15s ease;
  }
  button:active{ transform: translateY(1px); }
  button:hover{ background:rgba(255,255,255,.82); }
  .btnQuiet{
    background:rgba(255,255,255,.45);
  }

  .w{cursor:pointer; text-decoration: none; border-bottom:1px dotted rgba(24,19,21,.18)}
  .w:hover{ border-bottom-color: rgba(24,19,21,.40); }
  .verb{
    border-bottom: 2px solid rgba(24,19,21,.35);
    font-weight:900;
  }
  .lock{cursor:default; border-bottom:none}

  .footerBlock{
    margin-top:26px;
    padding-top:10px;
  }
  .finalActions{
    display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;
  }
  .gate{
    margin-top:12px;
    color:rgba(24,19,21,.60);
    font-size:14px;
    white-space:pre-line;
  }

  /* overlay share */
  .overlay{
    position:fixed; inset:0;
    background:rgba(10,10,12,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:9999;
  }
  .modal{
    width:min(980px, 96vw);
    border-radius:22px;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(255,255,255,.40);
    box-shadow: 0 30px 90px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .modalHead{
    display:flex; align-items:flex-start; justify-content:space-between;
    gap:12px;
    padding:14px 16px;
    border-bottom:1px solid rgba(24,19,21,.10);
  }
  .modalTitle{ font-weight:900; }
  .modalNote{ font-size:13px; color:rgba(24,19,21,.60); margin-top:2px; }
  .modalBody{ padding:14px 16px; }
  .shareGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  @media (min-width:900px){
    .shareGrid{ grid-template-columns: 1.1fr .9fr; }
  }
  .shareCanvasBox{
    border-radius:18px;
    border:1px solid rgba(24,19,21,.14);
    background:rgba(255,255,255,.75);
    padding:12px;
  }
  .shareCanvasBox canvas{ border-radius:14px; }
  textarea{
    width:100%;
    min-height:260px;
    border-radius:16px;
    border:1px solid rgba(24,19,21,.14);
    padding:12px;
    resize:vertical;
    font-size:14px;
    color:rgba(24,19,21,.84);
    background:rgba(255,255,255,.78);
    outline:none;
  }
  .modalFoot{
    display:flex; gap:10px; flex-wrap:wrap;
    padding:12px 16px 16px;
    border-top:1px solid rgba(24,19,21,.10);
  }
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:rgba(255,255,255,.86);
    border:1px solid rgba(24,19,21,.12);
    border-radius:999px;
    padding:10px 14px;
    box-shadow:0 16px 40px rgba(0,0,0,.18);
    color:rgba(24,19,21,.82);
    font-size:14px;
    display:none;
    z-index:99999;
  }

/* --- Long-form prelude blocks (I/II/III) --- */
.prelude{max-width:980px;margin:0 auto 26px auto;display:flex;flex-direction:column;gap:12px;}
.docBlock{background:rgba(255,255,255,.72);border:1px solid rgba(0,0,0,.08);border-radius:18px;padding:10px 14px;backdrop-filter: blur(4px);}
.docBlock summary{cursor:pointer;list-style:none;font-weight:650;letter-spacing:.02em;padding:6px 2px;}
.docBlock summary::-webkit-details-marker{display:none;}
.docBody{white-space:pre-wrap;line-height:1.58;font-size:15px;color:rgba(20,20,20,.92);padding:6px 2px 10px 2px;}
.docHint{font-size:12px;opacity:.72;max-width:980px;margin:0 auto;}
@media (max-width:740px){
  .docBody{font-size:14px;}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="title">MÓBILES — entrada</div>
      <div class="sig">assinatura: suiornotsui</div>
    </div>
    <div class="pill" id="pillState">campo: meio · meio · meio</div>
  </div>

  <div class="lead" id="leadText"></div>

  <!-- M1 -->
  <div class="section" id="m1">
    <div class="intro" id="introM1"></div>
    <div class="canvasBox">
      <canvas id="m1Canvas" width="1100" height="520"></canvas>
      <div class="controls">
        <button id="m1Tension">Tensionar o início</button>
        <button class="btnQuiet" id="m1Share">Partilhar este móbile</button>
      </div>
      <div class="textgen" id="m1Text"></div>
    </div>
  </div>

  <!-- M2 -->
  <div class="section" id="m2">
    <div class="intro" id="introM2"></div>
    <div class="canvasBox">
      <canvas id="m2Canvas" width="1100" height="520"></canvas>
      <div class="controls">
        <button id="m2Swap">Trocar frente ↔ fundo</button>
        <button class="btnQuiet" id="m2Share">Partilhar este móbile</button>
      </div>
      <div class="textgen" id="m2Text"></div>
    </div>
  </div>

  <!-- M3 -->
  <div class="section" id="m3">
    <div class="intro" id="introM3"></div>
    <div class="canvasBox">
      <canvas id="m3Canvas" width="1100" height="560"></canvas>
      <div class="controls">
        <button class="btnQuiet" id="m3Share">Partilhar este móbile</button>
      </div>
      <div class="textgen" id="m3Text"></div>
    </div>
  </div>

  <!-- M4 -->
  <div class="section" id="m4">
    <div class="intro" id="introM4"></div>
    <div class="canvasBox">
      <canvas id="m4Canvas" width="1100" height="560"></canvas>
      <div class="controls">
        <button class="btnQuiet" id="m4Share">Partilhar este móbile</button>
      </div>
      <div class="textgen" id="m4Text"></div>
    </div>
  </div>

  <!-- Final -->
  <div class="section footerBlock" id="final">
    <div class="intro" id="finalIntro"></div>
    <div class="canvasBox">
      <div class="intro" style="margin:0 6px 12px; color:rgba(24,19,21,.74)" id="closingText"></div>
      <div class="finalActions">
        <button id="btnFinalize">Gerar a minha exposição</button>
        <button class="btnQuiet" id="finalShare">Partilhar a exposição</button>
      </div>
      <div style="margin-top:12px"></div>
      <canvas id="finalCanvas" width="1100" height="620"></canvas>
      <div class="textgen" id="finalText" style="white-space:pre-line"></div>
      <div class="gate" id="weeklyGate"></div>
    </div>
  </div>
</div>

<!-- Share overlay -->
<div class="overlay" id="overlay" onclick="closeShare()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHead">
      <div>
        <div class="modalTitle" id="shareTitle">Partilhar</div>
        <div class="modalNote" id="shareNote"></div>
      </div>
      <button class="btnQuiet" onclick="closeShare()">Fechar</button>
    </div>
    <div class="modalBody">
      <div class="shareGrid">
        <div class="shareCanvasBox">
          <canvas id="shareCanvas" width="1200" height="900"></canvas>
        </div>
        <div>
          <textarea id="shareText"></textarea>
        </div>
      </div>
    </div>
    <div class="modalFoot">
      <button id="copyTextBtn">Copiar texto</button>
      <button id="downloadBtn">Baixar imagem</button>
      <button id="nativeShareBtn">Partilhar (telemóvel)</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============================================================
   CONFIG / PATHS (robusto para /mobiles/entrada/)
============================================================ */
const BASE_MOBILES = (() => {
  // tenta localizar o diretório /mobiles/ a partir da URL atual (GitHub Pages)
  const u = new URL(location.href);
  const parts = u.pathname.split("/").filter(Boolean);
  const i = parts.lastIndexOf("mobiles");
  if(i >= 0){
    u.pathname = "/" + parts.slice(0, i+1).join("/") + "/";
    u.search = ""; u.hash = "";
    return u;
  }
  // fallback: sobe um nível a partir de /entrada/
  return new URL("../", location.href);
})();
const SUI_JSON_URL = new URL("sui.json", BASE_MOBILES).toString();

/* ===================
   COPY FIXED TEXTS
=================== */
const TEXT_OPENING = ``; // substituted by three-block prelude below
const TEXT_I = `﻿I
O trabalho de suiornotsui inscreve-se numa zona rara da produção visual contemporânea em que a leveza material não coincide com superficialidade formal, e em que a aparente precariedade dos meios não constitui índice de fragilidade poética, mas estratégia estruturante de pensamento plástico. O uso recorrente de papéis de baixa gramatura, canetas de traço instável, lápis escolares, colagens frágeis, suportes quotidianos e materiais considerados menores no regime tradicional das belas-artes não configura um gesto de empobrecimento técnico, mas uma tomada de posição estética consciente: a escolha deliberada por uma materialidade que não estabiliza a forma, que não promete permanência, que não monumentaliza o gesto. A obra nasce já atravessada por sua própria condição de impermanência, e é precisamente nessa instabilidade que reside sua força estruturante. Não se trata, portanto, de um regime de “intimidade” ou “delicadeza” no sentido sentimentalizado com que frequentemente se recobre a produção visual feminina contemporânea, mas de uma operação formal rigorosa: a construção de imagens cuja consistência depende não da fixidez da forma, mas da relação dinâmica entre fragmentos, camadas, interrupções, reaparições e vazios.
Essa lógica fragmentária não deve ser compreendida como colagem arbitrária nem como acumulação decorativa de elementos. Ao contrário, a organização interna das composições de suiornotsui revela uma atenção estrutural à distribuição tensiva dos componentes visuais no campo da imagem. As figuras — crianças, animais, corpos suspensos, flores, objetos domésticos, paisagens rarefeitas — não ocupam o espaço de forma neutra; elas emergem como unidades instáveis, frequentemente deslocadas do centro, por vezes parcialmente obliteradas, outras vezes atravessadas por sobreposições gráficas que perturbam a leitura imediata. A relação entre fundo e figura é constantemente reconfigurada: o fundo nunca se reduz a suporte passivo, mas atua como campo ativo de forças que ora absorve, ora expulsa, ora fragmenta aquilo que nele aparece. Há, nesse gesto compositivo, uma recusa sistemática do fechamento formal e da centralidade estável, substituídas por uma organização espacial que privilegia a oscilação, a suspensão e a ambiguidade estrutural.
Essa oscilação manifesta-se também no modo como elementos visuais retornam ao longo de diferentes trabalhos, configurando um verdadeiro regime de arquivo em funcionamento. Fragmentos iconográficos — uma determinada flor, um gesto corporal, um animal específico, um motivo gráfico — reaparecem em contextos distintos, nunca como repetição idêntica, mas como variação instável de uma mesma matriz imagética. Esse procedimento aproxima o trabalho de suiornotsui menos da lógica da série e mais da lógica do campo: não há obras isoladas, mas um conjunto de operações que se atualizam diferentemente a cada nova configuração. O desenho não é aqui entendido como produto finalizado, mas como estado transitório de uma pesquisa formal contínua, em que o arquivo não é depósito de passado, mas reserva operatória de possibilidades futuras. A imagem nasce da reativação de restos, da recombinação de resíduos, da reinscrição de vestígios, num processo que impede tanto o esgotamento do repertório quanto a estabilização de uma linguagem fechada.
Esse modo de operar confere ao conjunto da produção um caráter estruturalmente móvel, no qual nenhuma imagem pode ser compreendida como definitiva. A obra existe como campo de variações, não como unidade conclusa. Essa mobilidade interna é acentuada ainda pela coexistência de técnicas heterogêneas em um mesmo suporte: aquarela diluída que convive com traços duros de caneta, colagens que interrompem a continuidade gráfica, zonas saturadas justapostas a grandes áreas de rarefação visual. Essa coexistência não se resolve por harmonia estilística, mas por tensão produtiva entre regimes materiais distintos. Cada técnica traz consigo uma temporalidade própria — a demora da mancha aquosa, a velocidade do traço, a rigidez do recorte colado — e a imagem final preserva visíveis essas diferenças de tempo, como se o processo de composição permanecesse inscrito na própria superfície do trabalho.
É precisamente essa recusa da homogeneização formal que impede a leitura do trabalho de suiornotsui como mero exercício estético de delicadeza ou nostalgia. Embora elementos iconográficos ligados à infância, à memória e ao universo doméstico estejam frequentemente presentes, eles não operam como tematização psicológica, mas como dispositivos formais de deslocamento. A infância, aqui, não aparece como conteúdo, mas como regime de instabilidade: formas que não se estabilizam, narrativas que não se fecham, personagens que flutuam entre presença e apagamento. A memória não é evocada como recuperação do passado, mas como estrutura fragmentária do próprio presente da imagem: aquilo que retorna nunca retorna intacto, mas como resto, como resíduo que já foi alterado pelo próprio ato de reaparecer. Nesse sentido, o trabalho constrói uma poética do retorno que está mais próxima de uma lógica estrutural da variação do que de uma estética do sentimental.
Essa organização instável do espaço, da forma e do arquivo aproxima o trabalho de suiornotsui de um conjunto de problemáticas centrais da história da arte do século XX que atravessaram as práticas construtivas, neoconcretas e processuais. A recusa do objeto fechado, a ênfase na relação entre partes móveis, a instabilidade entre figura e fundo, a valorização do processo sobre o produto final são questões que encontram ressonância direta em experiências como as de Lygia Clark, sobretudo em sua investigação sobre a obra como estrutura relacional e não como forma autônoma. Não se trata, evidentemente, de filiação estilística nem de genealogia direta, mas de convergência estrutural: em ambos os casos, a obra não se oferece como objeto contemplativo estabilizado, mas como campo de forças que exige reposicionamento contínuo do olhar e da experiência.
Essa convergência torna particularmente fecunda a leitura do trabalho de suiornotsui a partir do conceito de móbile, não no sentido restrito do objeto cinético tradicional, mas como princípio estrutural de organização formal. O móbile não designa aqui um artefato específico, mas um regime de composição no qual as partes não se subordinam a uma hierarquia fixa, mas se articulam segundo relações de equilíbrio provisório, suscetíveis a deslocamentos, reconfigurações e instabilidades. A obra torna-se, assim, menos um corpo e mais um campo: um conjunto de elementos cujas relações internas permanecem abertas, mesmo quando materialmente fixadas no suporte. O que se desloca não é o papel, mas a relação entre as forças que nele operam; o que permanece móvel não é o objeto, mas o regime de leitura que ele convoca.
Sob essa perspectiva, cada imagem de suiornotsui pode ser compreendida como um microcampo tensivo no qual diferentes vetores formais — densidade e rarefação, centralização e dispersão, continuidade e ruptura, presença e apagamento — coexistem em estado de equilíbrio precário. A força do trabalho reside precisamente nesse equilíbrio instável, nessa recusa de soluções formais totalizantes, nessa manutenção do campo em estado de abertura. O olhar não encontra repouso definitivo, a composição não se fecha em totalidade, a imagem não se oferece como resposta, mas como problema formal persistente. Trata-se, portanto, de um trabalho que opera no limite entre construção e dissolução, entre forma e resto, entre organização e falha produtiva.
É a partir desse diagnóstico rigoroso do funcionamento interno da obra — e não a partir de categorias exteriores ou temáticas — que o conceito de móbiles se torna operatório enquanto chave curatorial. Ele não é uma metáfora aplicada ao trabalho, mas uma formalização conceitual que emerge do próprio modo como as imagens se organizam, retornam, se desestabilizam e se rearticulam. O móbile, nesse contexto, nomeia uma condição estrutural: a da obra como sistema aberto de relações, como campo de variações e como dispositivo que resiste à fixação semântica e à captura interpretativa. É esse regime de mobilidade imanente que torna possível pensar o trabalho não apenas como conjunto de obras, mas como estrutura viva, capaz de sustentar uma prática curatorial que não se limite à seleção ou à exposição, mas que opere diretamente sobre as condições de emergência do sentido.`;
const TEXT_II = `II


Se o termo móbile se torna operatório para pensar o trabalho de suiornotsui, isso ocorre precisamente porque ele permite deslocar a análise do plano meramente iconográfico ou estilístico para o plano estrutural das relações formais. O móbile não nomeia aqui um objeto, mas um regime de organização: uma forma cuja identidade não reside na estabilidade de suas partes, mas na tensão permanente entre elas. Historicamente, o móbile emerge na obra de Alexander Calder como ruptura decisiva com a tradição escultórica baseada na massa, no peso e na centralidade estática. Ao introduzir o movimento real como princípio compositivo, Calder não apenas transforma a escultura em acontecimento temporal, mas desmonta a própria ideia de forma como totalidade fechada. A obra deixa de ser presença fixa e passa a existir como configuração contingente de equilíbrios instáveis, continuamente renegociados pela ação de forças externas — o ar, o acaso, o ambiente, o olhar em deslocamento. O móbile inaugura, assim, uma ontologia da obra como sistema relacional aberto.
Essa ontologia relacional da forma será radicalizada em diferentes vertentes da arte do século XX que passam a compreender a obra não mais como objeto autônomo, mas como dispositivo de relações. A investigação neoconcreta brasileira, em particular, constitui um dos momentos mais rigorosos dessa transformação. Em Lygia Clark, por exemplo, a noção de forma torna-se inseparável da experiência de manipulação, do tempo do gesto e da instabilidade estrutural. Os Bichos não são esculturas no sentido tradicional, mas estruturas articuladas que existem apenas na medida em que são constantemente reconfiguradas. Como observou Max Bense em seus textos sobre a produção construtiva brasileira, a força dessas experiências reside justamente na passagem da obra como objeto fechado para a obra como sistema de possibilidades formais, em que a configuração nunca se estabiliza definitivamente. A forma deixa de ser essência para tornar-se evento.
O que importa, nesse contexto, não é a mobilidade física em si, mas o princípio mais profundo que ela introduz: a recusa da forma como totalidade concluída e a afirmação da forma como campo de variações. Esse princípio atravessa também experiências como os Penetráveis e Parangolés de Hélio Oiticica, nos quais a obra só se realiza plenamente no deslocamento do corpo, na transformação contínua da configuração espacial e na imprevisibilidade da experiência. A arte deixa de ser aquilo que se contempla e passa a ser aquilo que acontece. Essa mutação não é apenas estética, mas epistemológica: ela implica uma redefinição radical do que significa produzir, experienciar e sustentar uma forma.
É nesse ponto que o conceito de móbile pode ser deslocado para além do domínio estrito da escultura ou da arte cinética, tornando-se uma categoria formal transversal capaz de nomear um regime mais amplo de organização cultural. Um móbile, nesse sentido expandido, não é aquilo que se move, mas aquilo cuja estrutura interna impede o fechamento. É aquilo cuja consistência depende da tensão entre partes heterogêneas, cuja identidade emerge da relação entre forças e não da estabilidade de uma essência. O móbile não é o contrário da forma; é o que torna a forma dependente de suas próprias condições de variação.
Essa leitura permite compreender o trabalho de suiornotsui não como exceção poética no interior da arte contemporânea, mas como inscrição rigorosa numa tradição crítica que interroga o estatuto da forma, do objeto e da obra. A mobilidade que atravessa suas composições — a instabilidade entre figura e fundo, a reorganização contínua do repertório imagético, a coexistência de temporalidades materiais distintas, a recusa do acabamento definitivo — não constitui um efeito estilístico, mas uma posição estrutural: a recusa de qualquer forma que se apresente como encerramento. A obra permanece aberta não porque careça de rigor, mas porque seu rigor reside precisamente em sustentar a abertura.
A partir desse ponto, o conceito de móbile pode ser ampliado ainda em uma direção decisiva: a da circulação. A palavra inglesa mobile carrega não apenas a ideia de movimento interno da forma, mas também a noção de mobilidade no espaço social, nos meios, nos circuitos de comunicação. Pensar o móbile hoje implica necessariamente pensar a condição das formas num ecossistema mediático em que imagens, textos e obras circulam incessantemente, mas frequentemente sem produzir presença efetiva, sem densidade de experiência, sem duração significativa. A mobilidade contemporânea é, paradoxalmente, uma mobilidade sem consistência: tudo circula, quase nada se sustenta.
É nesse ponto que o conceito de móbile se articula diretamente com uma problemática ontológica mais ampla: a das condições de emergência do sentido. Uma forma móvel no sentido forte — isto é, uma forma que não se fecha, mas também não se dissolve — exige um regime específico de organização capaz de sustentar a tensão entre abertura e consistência. Sem essa sustentação, a mobilidade degenera em fluxo indiferenciado; a circulação torna-se mero trânsito sem espessura. O desafio contemporâneo não é produzir movimento, mas construir estruturas que tornem o movimento legível, experienciável, habitável. O móbile, enquanto conceito formal rigoroso, permite nomear precisamente esse tipo de estrutura: aquela que suporta a variação sem colapsar em caos, e que resiste à fixação sem dissolver-se em dispersão.
Essa concepção desloca profundamente o campo da curadoria. Curar deixa de significar organizar obras em um espaço estável para significar construir condições de relação entre formas, tempos e experiências. O gesto curatorial, nesse regime, não é explicativo nem representacional, mas estrutural: trata-se de montar dispositivos que operem como móbiles conceituais, capazes de produzir campos de tensão nos quais obras, fragmentos, textos e públicos não se alinham segundo hierarquias fixas, mas se rearticulam continuamente. A curadoria deixa de ser gestão de objetos para tornar-se engenharia de relações.
Essa engenharia não é neutra: ela envolve uma posição ética e política em relação ao que pode emergir, ao que pode sustentar-se e ao que deve permanecer como resto. Uma estrutura verdadeiramente móvel não é aquela que absorve tudo, mas aquela que mantém zonas de indeterminação, resíduos irredutíveis, falhas produtivas. O móbile, enquanto princípio ontológico, implica necessariamente uma ética do não fechamento: a recusa da totalização, da captura completa, da estabilização final do sentido. A obra, o arquivo, a exposição e a própria experiência cultural permanecem, assim, em estado de devir estruturado.
É a partir desse horizonte teórico que o conceito de móbiles deixa de ser apenas uma chave interpretativa do trabalho de suiornotsui para tornar-se o fundamento de uma proposta curatorial mais ampla. Não se trata mais de expor obras como unidades concluídas, mas de construir um campo em que o próprio modo de organização das formas — visuais, textuais, interativas — opere segundo o regime do móbile: instável, relacional, tensivo, aberto à emergência e resistente à fixação. O que está em jogo já não é apenas a leitura de uma produção artística singular, mas a elaboração de um modelo de estrutura cultural capaz de sustentar a experiência do novo em meio à saturação contemporânea de imagens e discursos.`;
const TEXT_III = `III


Se as partes anteriores estabeleceram o móbile como categoria formal capaz de articular o trabalho de suiornotsui, a história da arte moderna e uma ontologia da instabilidade, resta agora enfrentar a questão decisiva: de que modo esse princípio pode ser formalizado não apenas como interpretação crítica, mas como estrutura material efetivamente operante? A proposta de MÓBILES não se limita, portanto, a um enquadramento curatorial do trabalho de uma artista; ela constitui uma tentativa de construir um dispositivo real no qual as teses formuladas até aqui se tornem operatórias. Não se trata de ilustrar conceitualmente uma teoria, mas de produzir uma máquina cuja própria lógica interna encarne — em sua forma de funcionamento — o regime do móbile enquanto forma aberta, tensiva e não totalizável.
O site, nesse sentido, não deve ser compreendido como “interface” no sentido corrente do termo, isto é, como superfície de mediação transparente entre um conteúdo prévio e um usuário exterior. Ele deve ser compreendido como objeto técnico em sentido forte: um dispositivo que organiza relações, distribui forças, impõe restrições e produz efeitos de sentido a partir da maneira como estrutura seus próprios elementos. A página não apresenta uma obra; ela própria é uma obra-dispositivo. Mais ainda: ela é uma máquina curatorial, no sentido em que produz condições de relação entre fragmentos, textos, interações e percursos, em vez de simplesmente ordenar materiais já significantes.
A primeira camada desse dispositivo — a chamada página-base — não funciona como acervo no sentido tradicional, mas como campo de potencialidades. O conjunto de fragmentos visuais ali presentes não constitui uma coleção de unidades autônomas, mas um repertório latente cujas propriedades são definidas por parâmetros formais mínimos: posição relativa, densidade compositiva, continuidade ou ruptura, intensidade gráfica. Esses parâmetros não são descrições de conteúdo, mas traços operatórios que permitem que cada fragmento atue como força em um campo relacional. O fragmento deixa de ser imagem isolada para tornar-se vetor possível de organização formal. A página-base, assim, não arquiva obras: ela disponibiliza forças.
A segunda camada — a página de entrada — introduz o elemento decisivo da máquina: a interação como perturbação de um campo e não como escolha subjetiva. Cada gesto do visitante (um clique, uma reconfiguração, uma insistência, uma cessação) não é interpretado como preferência, mas como modificação local de um estado tensivo global. O dispositivo lê a interação como acontecimento material, não como opinião. Isso significa que o visitante não seleciona conteúdos, mas participa involuntariamente da reorganização de um sistema. A experiência que emerge daí é radicalmente distinta daquela proporcionada por interfaces interativas convencionais: não se trata de customizar um resultado, mas de experimentar os efeitos de perturbações sucessivas sobre uma estrutura que resiste, responde, se reequilibra e, por vezes, estabiliza provisoriamente.
Essa lógica transforma o texto gerado pelo sistema em algo igualmente distinto de uma mensagem comunicativa ou de um comentário interpretativo. O texto não explica as imagens nem traduz seus conteúdos; ele emerge como efeito formal da configuração tensiva do campo. Os verbos que estruturam esses textos — sustentar, desviar, estancar, cortar, arrastar — não nomeiam temas, mas regimes de passagem. Os advérbios mínimos que os acompanham — mais, menos, quase, ainda — não qualificam psicologicamente a experiência, mas indicam gradientes de intensidade e saturação. O texto não comunica um significado externo; ele torna perceptível a dinâmica interna do sistema. Ele não diz “o que é”, mas deixa ver “como está operando”.
O elemento decisivo dessa arquitetura é que nenhuma das camadas — visual, textual, interativa — funciona de modo isolado. Cada gesto em qualquer plano altera os demais por espraiamento: uma modificação local no regime visual afeta a escolha verbal; uma insistência textual altera a distribuição espacial dos fragmentos; uma sequência de reconfigurações modifica as probabilidades internas do campo. Essa co-dependência estrutural impede que o dispositivo se estabilize como mera soma de partes e força a experiência a ocorrer como campo relacional. O sentido não está em nenhum elemento isolado, mas na própria dinâmica de suas interações.
A terceira camada — o estado expositivo condensado — torna ainda mais evidente a dimensão propriamente curatorial do dispositivo. Ao produzir configurações periódicas que resultam da acumulação difusa de interações anônimas, o sistema desloca o conceito de exposição do plano da seleção autoral para o plano da emergência estrutural. Não há aqui um curador que escolhe quais obras entram e quais saem; há uma máquina curatorial que sintetiza, a partir de múltiplas perturbações mínimas, um estado provisório do campo. A exposição deixa de ser um recorte estático para tornar-se um acontecimento temporal: um momento de estabilização relativa de forças que logo voltará a se transformar.
O que se formaliza, assim, é uma concepção radicalmente distinta de curadoria. Curar não é explicar, não é tematizar, não é organizar discursos sobre obras; curar é construir dispositivos que tornem possível a emergência de relações significantes entre formas heterogêneas. A máquina MÓBILES não interpreta o trabalho de suiornotsui: ela cria um espaço estrutural no qual as qualidades formais de seu trabalho — fragmentação, leveza, mobilidade, retorno, instabilidade — tornam-se princípios operatórios de organização. A curadoria deixa de ser um gesto exterior à obra para tornar-se continuação formal de suas próprias exigências internas.
Nesse sentido, o dispositivo não apenas acolhe o trabalho de suiornotsui, mas o prolonga estruturalmente. A lógica de recomposição permanente que atravessa sua prática artística encontra aqui um correlato técnico rigoroso: um sistema em que nada se fecha definitivamente, em que toda configuração permanece provisória, em que o repertório nunca se esgota e em que a própria exposição assume a forma de um processo em devir. A máquina não representa o trabalho; ela o reencena em outro plano material.
Essa reencenação, contudo, não é neutra. Ela constitui uma posição ontológica clara diante do problema contemporâneo da circulação cultural. Em um contexto em que imagens e discursos circulam de maneira incessante, mas frequentemente sem produzir experiência, o dispositivo MÓBILES aposta em um modelo oposto: restringir para intensificar, estruturar para permitir emergência, limitar para tornar perceptível. A máquina não visa maximizar engajamento, fluidez ou consumo; ela constrói atrito, lentidão, resistência e hesitação como condições para que algo possa, eventualmente, sustentar-se.
O dispositivo opera, assim, como uma crítica material às formas dominantes de mediação cultural. Ao recusar a transparência da interface, a lógica da recomendação, a personalização algorítmica e a captura do usuário, MÓBILES propõe uma experiência que não se organiza em torno do sujeito consumidor, mas em torno do campo de forças que se constitui entre elementos heterogêneos. O visitante não é o centro da experiência, mas uma de suas variáveis. O sistema não se adapta ao usuário; o usuário é atravessado pelo sistema.
Essa inversão é decisiva. Ela recoloca a experiência estética fora do regime da escolha, da preferência e da identificação imediata e a reinscreve no regime da exposição a uma estrutura que resiste, que impõe forma, que exige atenção e que produz, eventualmente, momentos de cessação significativa. Quando o gesto cessa, não é porque algo foi plenamente compreendido, mas porque algo se sustentou suficientemente para interromper o movimento. Essa cessação não é conclusão; é apenas um momento de consistência no fluxo.
É nesse ponto que o dispositivo deixa de ser apenas um experimento formal e assume plenamente sua dimensão ontológica. Ele não propõe uma nova maneira de ver obras, mas uma nova maneira de pensar as condições de existência do sentido. Ele afirma, na própria materialidade de seu funcionamento, que o sentido não é transmitido, mas emerge; que não é comunicado, mas sustentado; que não reside nos conteúdos, mas nas relações; que não se estabiliza por consenso, mas por tensão. A máquina torna visível, operativamente, uma teoria da significação que não poderia ser plenamente formulada apenas no plano discursivo.`;

const INTRO_M1 = `Móbile 1 — Perturbação inicial e campo de emergência
O primeiro móbile não opera como escolha, mas como perturbação. Sua função não é permitir que o visitante “decida” uma configuração, mas introduzir um desvio inaugural no campo. Tecnicamente, isso se formaliza como uma redistribuição probabilística dos fragmentos visuais e dos pesos semânticos do sistema; conceitualmente, trata-se de instaurar aquilo que poderíamos chamar de acidente controlado: um gesto mínimo que desorganiza o equilíbrio inicial sem conduzir ao caos. Essa lógica deriva diretamente da compreensão do sentido não como conteúdo, mas como efeito de relação — e da curadoria não como seleção, mas como engenharia de condições.
O que está em jogo aqui é a construção de um campo sensível em que nenhuma configuração é natural ou neutra, mas sempre resultado de um estado provisório de forças. O móbile não apresenta obras: ele redistribui vetores. Cada fragmento emerge não porque “representa algo”, mas porque, naquele instante, sustenta uma posição mais intensa no campo. Esse regime é homólogo ao próprio funcionamento do trabalho de suiornotsui, no qual imagens retornam, materiais reaparecem, formas reaprendem a ocupar o espaço — nunca como repetição idêntica, mas como reconfiguração instável de um arquivo vivo.
Do ponto de vista técnico, o que o sistema executa é uma reponderação do estado global: pequenas variações nos eixos de posição, densidade e continuidade são suficientes para alterar profundamente a configuração resultante. Do ponto de vista conceitual, porém, o efeito é mais profundo: demonstra-se que a emergência não depende de uma intenção autoral clara nem de uma escolha consciente, mas da disposição correta de um campo de relações. O primeiro móbile existe para tornar sensível essa condição fundamental: antes de qualquer forma, antes de qualquer interpretação, é preciso que algo se desloque.`;


const INTRO_M2 =
`Móbile 2 — Reversibilidade, posição e sintaxe do visível
Se o primeiro móbile introduz a perturbação inaugural, o segundo explicita a existência de estrutura. Aqui, a experiência deixa de ser apenas campo instável e passa a revelar que toda emergência ocorre sob condições formais precisas. A operação é deliberadamente simples: frente e fundo podem ser alternados; a ordem dos elementos pode ser deslocada; a posição de cada fragmento deixa de ser evidente. Contudo, essa simplicidade técnica corresponde a uma tese conceitual exigente: o sentido não reside nos elementos, mas nas relações posicionais que os articulam.
Ao tornar reversível aquilo que, na percepção ordinária, aparece como dado — o que está em primeiro plano, o que recua, o que sustenta, o que é sustentado — este móbile transforma o visitante em operador de uma sintaxe espacial. A cada gesto, evidencia-se que o significado não acompanha a imagem como legenda, mas emerge da redistribuição dos lugares. Frente e fundo deixam de ser propriedades dos fragmentos e passam a ser funções do campo. Tal procedimento encontra ressonância direta no trabalho de suiornotsui, cuja composição raramente estabiliza um centro: personagens flutuam, cenas parecem suspensas, elementos que deveriam sustentar a imagem tornam-se periféricos, enquanto detalhes frágeis assumem uma potência inesperada de organização.
Tecnicamente, este móbile atua sobre o eixo posicional do sistema, fazendo com que pequenas alterações de ordenação gerem consequências globais na configuração semântica. Conceitualmente, ele opera como uma demonstração prática de que não existe neutralidade na disposição: toda escolha espacial é já uma decisão de mundo. A curadoria, nesse regime, não é interpretação nem explicação, mas montagem de condições estruturais nas quais a reversibilidade permanece visível, ativa, e irredutível a uma leitura única. O que se oferece aqui não é liberdade de escolha, mas exposição do próprio mecanismo pelo qual a escolha se torna possível.`;

const INTRO_M3 =
`Móbile 3 — Intensidade, insistência e campo tensivo
Se o segundo móbile torna perceptível a estrutura, o terceiro introduz uma dimensão mais radical: a experiência da pressão. Aqui, o gesto do visitante deixa de ser meramente redistributivo e passa a atuar como força acumulativa. Cada clique não escolhe, não seleciona, não prefere — ele insiste. E é essa insistência, e não a vontade declarada, que reorganiza progressivamente o campo. O que se torna visível é um princípio central da máquina curatorial-semântica: o sentido não emerge por decisão, mas por saturação; não por intenção, mas pelo acúmulo de pequenas perturbações que, ao ultrapassarem um limiar, produzem mutação de regime.
Neste móbile, a lógica operatória aproxima-se deliberadamente do funcionamento real dos processos perceptivos, linguísticos e afetivos: nada muda abruptamente por um único gesto, mas tudo pode se transformar quando um mesmo gesto retorna, insiste, se repete, pressiona. A imagem torna-se, assim, um campo de forças em desequilíbrio contínuo, no qual certos fragmentos ganham peso não por serem “melhores” ou “mais belos”, mas porque suportaram mais tempo de exposição à pressão do gesto. A analogia com o trabalho de suiornotsui é aqui estrutural: seus desenhos raramente se impõem como forma totalizante; antes, operam por acumulação de detalhes frágeis, pequenas recorrências gráficas, mínimas variações cromáticas que, por repetição e persistência, acabam por organizar a percepção global da cena.
Do ponto de vista técnico, este móbile atua sobre os eixos de densidade e continuidade do sistema, alterando os pesos relativos dos fragmentos e provocando um reequilíbrio dinâmico do conjunto. Cada interação local repercute no campo inteiro com intensidade decrescente, produzindo um efeito de espraiamento que jamais é totalmente controlável. Conceitualmente, o que se demonstra não é uma estética da escolha, mas uma ontologia da insistência: aquilo que permanece não é o que foi eleito, mas o que conseguiu sustentar-se no interior de um campo instável. A curadoria, aqui, deixa definitivamente de ser seleção de conteúdos e passa a ser engenharia de condições para que algo, sob pressão, encontre a sua própria forma provisória de consistência.`;

const INTRO_M4 =
`Móbile 4 — Grafema, materialidade e regimes de inscrição
O quarto móbile introduz uma camada decisiva para a arquitetura conceitual do projeto: a materialidade da linguagem enquanto força operatória. Se os móbiles anteriores já haviam tornado perceptíveis a estrutura, a distribuição e a pressão, aqui o próprio tecido da escrita passa a funcionar como dispositivo. Não se trata de tematizar a linguagem, nem de explicá-la como conteúdo, mas de fazê-la operar como plano material entre outros — com peso, resistência, textura e ritmo próprios. O texto deixa de ser comentário sobre a imagem e passa a agir no mesmo regime que ela: como inscrição gráfica submetida a tensões, modulações e perturbações.
A escolha deliberada de trabalhar com grafemas — e não com som, voz ou oralidade — inscreve esta camada no campo de uma fonografia silenciosa: uma escrita que sugere regimes de força sem recorrer à emissão acústica. Certas configurações gráficas operam como cortes secos; outras como prolongamentos, escorrimentos, atritos; outras ainda como hesitações ou quase-cessações. Essa dimensão não é metafórica, mas estrutural: do mesmo modo que no trabalho de suiornotsui a diferença entre um lápis de cor infantil, uma caneta hidrográfica barata e um marcador mais denso não é apenas estética, mas material, aqui também as palavras são tratadas como corpos gráficos distintos, atravessados por pesos e velocidades diferentes. A escrita participa da exposição não como legenda, mas como matéria sensível.
Operacionalmente, este móbile atua sobre o regime fonográfico do sistema, inclinando a máquina para determinadas famílias de realização verbal e gráfica. Interagir com uma palavra, com uma letra, com uma sequência de grafemas não reforça um significado, mas desloca probabilidades: certas formas tendem a reaparecer, outras a rarefazer-se, outras ainda a deformar-se progressivamente. O que se torna visível é uma tese forte, raramente assumida na prática curatorial: que o sentido não reside nos conteúdos, mas na forma material de inscrição que os sustenta. Assim como os desenhos de suiornotsui fazem da precariedade do suporte, da leveza do traço e da fragilidade do material uma condição produtiva — e não um limite —, este móbile transforma a própria linguagem em campo de experimentação, onde escrever é já curar, e curar é já construir condições para que algo, instável e provisório, possa emergir como presença.`;

const TEXT_FINAL_CLOSING =
`Configuração provisória — cálculo, cessação e emergência
O que se apresenta a seguir não é síntese expressiva, nem tradução de preferências, nem retrato psicológico de um sujeito interativo. A configuração que emerge ao final do percurso pelos móbiles não resulta de escolhas diretas, mas de um acúmulo de perturbações locais que alteraram progressivamente o campo global da máquina. Cada gesto — um clique, uma troca de posição, uma insistência, uma cessação — não operou como decisão estética, mas como deslocamento de peso em um sistema de relações. O que se torna visível aqui é, portanto, um estado de campo: uma disposição momentaneamente estável entre forças que poderiam ter se organizado de outro modo, sob outras condições.
A máquina não pergunta “o que você quer ver”. Ela observa como o campo responde à pressão. Os fragmentos que persistem não o fazem por preferência, mas por compatibilidade estrutural com o regime que se formou. As palavras que permanecem não são escolhidas por afinidade semântica, mas por sustentarem melhor o gradiente tensivo instaurado ao longo do percurso. A imagem final não é composição deliberada, mas consequência: um arranjo que resistiu mais tempo à perturbação do que os demais, até que o gesto cessou. A cessação, aqui, é o único critério real de conclusão: não quando algo agrada, mas quando algo se mantém.
Por isso, este estado não deve ser entendido como obra, nem como resultado, nem como identidade. Ele é uma cristalização provisória de relações — uma espécie de fotografia do campo no instante em que deixou de ser tensionado. Poderia ter sido outro. Poderá ser outro novamente. Sua importância não está na forma que assume, mas no fato de ter conseguido emergir: de ter conquistado consistência suficiente para não colapsar imediatamente em ruído. O que se oferece à experiência não é um produto, mas a prova de um processo: a demonstração de que, sob certas condições materiais e formais, algo pode adquirir presença sem ter sido projetado como forma final.
Gerar esta configuração não é concluir a exposição, mas torná-la momentaneamente legível. Trata-se menos de um fim do que de um limiar: um ponto a partir do qual se pode observar, com alguma clareza, como a máquina opera, como as relações se distribuem, como o resto persiste, como a emergência acontece. O que se vê aqui não é “a sua exposição”, mas a evidência de que uma exposição pode existir sem tema, sem narrativa, sem explicação — sustentada apenas pela coerência interna de suas forças.`;

/* ============================================================
   UTILS
============================================================ */
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const rnd = (a,b)=>a+Math.random()*(b-a);
const pick = (arr)=>arr[(Math.random()*arr.length)|0];

// ---- determinismo para resultados finais (e para estabilizar a presença da Sui)
const hashStr = (s)=>{
  let h = 2166136261>>>0; // FNV-1a
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h>>>0;
};
const mulberry32 = (seed)=>{
  let t = seed>>>0;
  return ()=>{
    t += 0x6D2B79F5;
    let x = Math.imul(t ^ (t>>>15), 1 | t);
    x ^= x + Math.imul(x ^ (x>>>7), 61 | x);
    return ((x ^ (x>>>14))>>>0) / 4294967296;
  };
};
const pickR = (arr, r)=>arr[(r()*arr.length)|0];


function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display="block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{ t.style.display="none"; }, 1500);
}

/* ============================================================
   FIELD (120 slots + “gramática visual”)
============================================================ */
const FAMILIES = [
  {name:"F1", front:-0.2, dense:-0.2, cont:+0.9},
  {name:"F2", front:+0.6, dense:+0.1, cont:-0.9},
  {name:"F3", front:+0.2, dense:-0.1, cont:-0.2},
  {name:"F4", front:+0.0, dense:+0.0, cont:+0.5},
  {name:"F5", front:+0.4, dense:+0.3, cont:-0.6},
  {name:"F6", front:+0.1, dense:+0.9, cont:+0.1},
  {name:"F7", front:-0.6, dense:-0.9, cont:+0.2},
  {name:"F8", front:+0.2, dense:+0.1, cont:-0.1},
  {name:"F9", front:-0.1, dense:-0.1, cont:+0.0},
  {name:"F10",front:+0.3, dense:+0.2, cont:-0.2},
  {name:"F11",front:+0.5, dense:-0.1, cont:-0.4},
  {name:"F12",front:+0.1, dense:+0.8, cont:-0.7},
];

const FIELD = { slots:[] };

// Sui map
let SUI_MAP = null;
let WANT_SUI = true; // decidido uma vez por sessão (estável)

function buildField(){
  FIELD.slots = [];
  for(let i=1;i<=120;i++){
    const famIndex = Math.min(11, Math.floor((i-1)/10));
    const fam = FAMILIES[famIndex];
    FIELD.slots.push({
      idx:i,
      fam:fam.name,
      v: (i-1)%10,
      axes:{
        front: clamp(fam.front + rnd(-0.18,0.18), -1, 1),
        dense: clamp(fam.dense + rnd(-0.18,0.18), -1, 1),
        cont:  clamp(fam.cont  + rnd(-0.18,0.18), -1, 1),
      },
      sui: null,
      _img: null
    });
  }
}

/* ============================================================
   LOAD SUI MAP (robusto + fallback pro slot 53)
============================================================ */
async function tryLoadSui(){
  // tenta carregar o mapeamento /mobiles/sui.json e, em qualquer caso, garante um fallback robusto para o slot 53
  const probeImage = (url) => new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=> resolve(true);
    img.onerror = ()=> resolve(false);
    img.src = url + "?probe=" + Date.now();
  });

  try{
    const res = await fetch(SUI_JSON_URL + "?cache=" + Date.now(), { cache:"no-store" });
    if(!res.ok) throw new Error("sui.json não carregou");
    const data = await res.json();
    SUI_MAP = data;

    for(const s of FIELD.slots){
      const key = String(s.idx); // "53"
      if(SUI_MAP && SUI_MAP[key]){
        const rel = SUI_MAP[key]; // "assets/sui/slot_053.jpg"
        s.sui = { path: new URL(String(rel).replace(/^\.\?\/*/,"").replace(/^\.?\/*/,""), BASE_MOBILES).toString() };
      }
    }
  }catch(e){
    SUI_MAP = null;
  }

  // fallback mínimo: se falhou (ou se o caminho/ extensão divergir), ainda assim fixa o slot 53 em um dos caminhos prováveis
  const s53 = FIELD.slots[52];
  if(!s53.sui){
    const candidates = [
      "assets/sui/slot_053.jpg",
      "assets/sui/slot_053.JPG",
      "assets/sui/slot_053.jpeg",
      "assets/sui/slot_053.JPEG",
      "assets/sui/slot_053.png",
      "assets/sui/slot_053.PNG",
    ].map(p => new URL(p, BASE_MOBILES).toString());

    for(const u of candidates){
      if(await probeImage(u)){
        s53.sui = { path: u };
        break;
      }
    }
    if(!s53.sui){
      s53.sui = { path: candidates[0] };
    }
  }
  // decisão estável por sessão: 90% de chance de exigir pelo menos 1 Sui
  WANT_SUI = (Math.random() < 0.90);
}

/* ============================================================
   ESTADO GLOBAL (tensivo + fonográfico)
============================================================ */
const G = {
  front: 0,
  dense: 0,
  cont: 0,
  pressure: 0.35,
  birthMode: 0,
  ph:{ dry:0, voiced:0, open:0 }
};

const Mob = {
  m1:{ slots:null },
  m2:{ slots:null, flip:false, subjKey:null, objKey:null, verbKey:null, verbIx:0 },
  m3:{ slots:null, focusFam:null, intensity:0, clicks:0 },
  m4:{ slots:null, focusPh:null, intensity:0, clicks:0 },
  final:{ ready:false, slots:null }
};

function applyDelta(d){
  G.front = clamp(G.front + (d.front||0), -1, 1);
  G.dense = clamp(G.dense + (d.dense||0), -1, 1);
  G.cont  = clamp(G.cont  + (d.cont ||0), -1, 1);
  G.pressure = clamp(G.pressure + (d.pressure||0), 0, 3);

  if(d.ph){
    G.ph.dry    = clamp(G.ph.dry    + (d.ph.dry||0),    -1.2, 1.2);
    G.ph.voiced = clamp(G.ph.voiced + (d.ph.voiced||0), -1.2, 1.2);
    G.ph.open   = clamp(G.ph.open   + (d.ph.open||0),   -1.2, 1.2);
  }
  updatePill();
}

function updatePill(){
  const s = (x, a, b)=> x< -0.18 ? a : x>0.18 ? b : "meio";
  document.getElementById("pillState").textContent =
    `campo: ${s(G.front,"fundo","frente")} · ${s(G.dense,"rarefeito","denso")} · ${s(G.cont,"corte","contínuo")}`;
}

function phMode(){
  const d=Math.abs(G.ph.dry), v=Math.abs(G.ph.voiced), o=Math.abs(G.ph.open);
  if(d>=v && d>=o) return "surda";
  if(v>=d && v>=o) return "sonora";
  return "fricativa";
}

/* ============================================================
   SCORE / SAMPLE (seleção tensiva + “gramática visual”)
============================================================ */
function slotScore(slot){
  const dx =
    Math.abs(slot.axes.front - G.front) * 0.9 +
    Math.abs(slot.axes.dense - G.dense) * 0.7 +
    Math.abs(slot.axes.cont  - G.cont ) * 1.0;

  const phBonus =
    (G.ph.dry    * (-slot.axes.cont))*0.25 +
    (G.ph.open   * ( slot.axes.cont))*0.22 +
    (G.ph.voiced * ( slot.axes.dense))*0.15;

  let score = -(dx) + phBonus + rnd(-0.06,0.06);

  if(slot.sui) score += 0.95;

  return score;
}

function sampleSlots(n){
  const pool = FIELD.slots.slice();
  pool.sort((a,b)=> slotScore(b) - slotScore(a));
  const K = Math.min(36, pool.length);
  const top = pool.slice(0,K);
  for(let i=top.length-1;i>0;i--){
    const j = (Math.random()*(i+1))|0;
    [top[i], top[j]] = [top[j], top[i]];
  }
  return top.slice(0,n);
}

function sampleSlotsSeeded(n, seed){
  const r = mulberry32(seed);
  const idxs = [];
  for(let i=1;i<=FIELD.slots.length;i++) idxs.push(i);
  // Fisher-Yates com RNG determinístico
  for(let i=idxs.length-1;i>0;i--){
    const j = (r()*(i+1))|0;
    const tmp = idxs[i]; idxs[i]=idxs[j]; idxs[j]=tmp;
  }
  const out = [];
  for(let k=0;k<n;k++){
    const ix = idxs[k]-1;
    out.push(FIELD.slots[ix]);
  }
  return out;
}

function finalSeed(){
  // assinatura do estado: quantiza vetores globais + estados dos 4 móbiles
  const q = (x)=>Math.round((x||0)*100)/100;
  const sig = [
    "v2",
    `f${q(G.front)}`, `d${q(G.dense)}`, `c${q(G.cont)}`,
    `p${q(G.pressure)}`,
    `m1_${Mob.m1.mode||0}_${Mob.m1.clicks||0}`,
    `m2_${Mob.m2.flip?1:0}_${Mob.m2.subjKey}_${Mob.m2.objKey}_${Mob.m2.verbKey}_${Mob.m2.verbIx||0}`,
    `m3_${Mob.m3.focusFam||0}_${q(Mob.m3.intensity||0)}_${Mob.m3.clicks||0}`,
    `m4_${Mob.m4.focusPh||"none"}_${q(Mob.m4.intensity||0)}_${Mob.m4.clicks||0}`
  ].join("|");
  return hashStr(sig);
}

/* --- regra Sui: em cada móbile, 90% força pelo menos 1 slot 53 --- */
function ensureSui(slots){
  // Regra: garantir presença da Sui (slot 53) com alta probabilidade,
  // mas sem flutuar a cada rerender (decisão estável por sessão).
  if(!WANT_SUI) return slots;

  const has = slots.some(s => s && s.idx===53 && s.sui);
  if(has) return slots;

  const s53 = FIELD.slots[52]; // idx 53
  if(!s53 || !s53.sui) return slots;

  const out = slots.slice();
  out[out.length-1] = s53; // força ao menos 1
  return out;
}

/* ============================================================
   LÉXICO (70 operadores × 3 realizações) — exatamente como aprovado
============================================================ */
const LEX = {
  vestigio:{surda:"traço",sonora:"marca",fricativa:"sombra"},
  sopro:{surda:"pingo",sonora:"bafo",fricativa:"suspiro"},
  dobra:{surda:"prega",sonora:"curva",fricativa:"flexão"},
  canto:{surda:"quina",sonora:"beira",fricativa:"franja"},
  margem:{surda:"limite",sonora:"borda",fricativa:"fronteira"},
  poeira:{surda:"pó",sonora:"bruma",fricativa:"cinza"},
  silencio:{surda:"pausa",sonora:"calma",fricativa:"sussurro"},
  rastro:{surda:"pegada",sonora:"vesta",fricativa:"resíduo"},
  fragmento:{surda:"cortezinho",sonora:"bordado",fricativa:"desfiado"},
  detalhe:{surda:"ponto",sonora:"miolo",fricativa:"nuança"},
  lembranca:{surda:"nota",sonora:"memória",fricativa:"recordação"},
  demora:{surda:"pausa",sonora:"espera",fricativa:"suspensão"},
  intervalo:{surda:"corte",sonora:"entre",fricativa:"fresta"},
  eco:{surda:"toque",sonora:"resposta",fricativa:"ressonância"},
  resto:{surda:"ruga",sonora:"sobra",fricativa:"resíduo"},
  plano:{surda:"linha",sonora:"base",fricativa:"superfície"},
  camada:{surda:"capa",sonora:"nível",fricativa:"espessura"},
  textura:{surda:"trama",sonora:"tecido",fricativa:"fibra"},
  superficie:{surda:"pele",sonora:"face",fricativa:"película"},
  escala:{surda:"passo",sonora:"medida",fricativa:"proporção"},
  ritmo:{surda:"pulso",sonora:"cadência",fricativa:"fluência"},
  materia:{surda:"corpo",sonora:"substância",fricativa:"massa"},
  presenca:{surda:"toque",sonora:"vulto",fricativa:"sombra"},
  tensao:{surda:"nó",sonora:"peso",fricativa:"pressão"},
  campo:{surda:"plano",sonora:"território",fricativa:"ambiente"},
  emergencia:{surda:"salto",sonora:"aparição",fricativa:"insurgência"},
  configuracao:{surda:"forma",sonora:"estrutura",fricativa:"composição"},
  cessacao:{surda:"corte",sonora:"encerramento",fricativa:"silenciamento"},

  aproximar:{surda:"chegar",sonora:"beirar",fricativa:"esfumar"},
  reparar:{surda:"notar",sonora:"observar",fricativa:"esmiuçar"},
  tocar:{surda:"tatear",sonora:"roçar",fricativa:"aflorar"},
  escutar:{surda:"ouvir",sonora:"acolher",fricativa:"sintonizar"},
  demorarV:{surda:"parar",sonora:"permanecer",fricativa:"alongar-se"},
  pousar:{surda:"cair",sonora:"assentar",fricativa:"deslizar"},
  acompanhar:{surda:"seguir",sonora:"amparar",fricativa:"entrelaçar"},
  cuidar:{surda:"zelar",sonora:"nutrir",fricativa:"suavizar"},

  recortar:{surda:"cortar",sonora:"delimitar",fricativa:"fissurar"},
  deslocar:{surda:"mover",sonora:"transferir",fricativa:"deslizar"},
  sustentar:{surda:"segurar",sonora:"manter",fricativa:"suspender"},
  distribuir:{surda:"partir",sonora:"organizar",fricativa:"espalhar"},
  sobrepor:{surda:"cobrir",sonora:"acumular",fricativa:"sobrefluir"},
  atravessar:{surda:"passar",sonora:"cruzar",fricativa:"permeiar"},
  insinuar:{surda:"sugerir",sonora:"indicar",fricativa:"sussurrar"},

  insistir:{surda:"bater",sonora:"persistir",fricativa:"ressoar"},
  interromper:{surda:"cortar",sonora:"cessar",fricativa:"esvair-se"},
  fixar:{surda:"marcar",sonora:"estabelecer",fricativa:"sedimentar"},
  suspender:{surda:"parar",sonora:"reter",fricativa:"flutuar"},
  reter:{surda:"prender",sonora:"guardar",fricativa:"conservar"},
  abandonar:{surda:"largar",sonora:"deixar",fricativa:"dissolver"},
  transformar:{surda:"romper",sonora:"converter",fricativa:"transfigurar"},

  leve:{surda:"claro",sonora:"brando",fricativa:"suave"},
  minimo:{surda:"curto",sonora:"pequeno",fricativa:"sutil"},
  fragil:{surda:"ténue",sonora:"delicado",fricativa:"sensível"},
  tenue:{surda:"fino",sonora:"delgado",fricativa:"esfumado"},
  quaseAdj:{surda:"breve",sonora:"próximo",fricativa:"difuso"},

  opaco:{surda:"denso",sonora:"turvo",fricativa:"fosco"},
  poroso:{surda:"aberto",sonora:"vazado",fricativa:"permeável"},
  irregular:{surda:"torto",sonora:"instável",fricativa:"assimétrico"},
  difuso:{surda:"solto",sonora:"amplo",fricativa:"disperso"},

  latente:{surda:"oculto",sonora:"presente",fricativa:"subjacente"},
  instavel:{surda:"quebrado",sonora:"oscilante",fricativa:"flutuante"},
  provisorio:{surda:"breve",sonora:"mutável",fricativa:"transitório"},

  ainda:{surda:"já",sonora:"agora",fricativa:"sempre"},
  quaseAdv:{surda:"logo",sonora:"perto",fricativa:"talvez"},
  lentamente:{surda:"aos poucos",sonora:"com calma",fricativa:"suavemente"},
  porVezes:{surda:"às vezes",sonora:"frequentemente",fricativa:"ocasionalmente"},
  sempre:{surda:"toda vez",sonora:"continuamente",fricativa:"infinitamente"},
  raramente:{surda:"quase nunca",sonora:"poucas vezes",fricativa:"esporadicamente"},
  talvez:{surda:"quem sabe",sonora:"possivelmente",fricativa:"eventualmente"},
  agora:{surda:"já",sonora:"neste momento",fricativa:"presentemente"},
};

const N_SENS = ["vestigio","sopro","dobra","canto","margem","poeira","silencio","rastro","fragmento","detalhe"];
const N_MEM  = ["lembranca","demora","intervalo","eco","resto","cessacao"];
const N_PLAS = ["plano","camada","textura","superficie","escala","ritmo","materia"];
const N_CUR  = ["presenca","tensao","campo","emergencia","configuracao"];

const V_SENS = ["aproximar","reparar","tocar","escutar","demorarV","pousar","acompanhar","cuidar"];
const V_COMP = ["recortar","deslocar","sustentar","distribuir","sobrepor","atravessar","insinuar"];
const V_DEC  = ["insistir","interromper","fixar","suspender","reter","abandonar","transformar"];

const ADJ_S  = ["leve","minimo","fragil","tenue","quaseAdj"];
const ADJ_P  = ["opaco","poroso","irregular","difuso"];
const ADJ_C  = ["latente","instavel","provisorio"];

const ADJ = ADJ_S.concat(ADJ_P, ADJ_C);

const ADV    = ["ainda","quaseAdv","lentamente","porVezes","sempre","raramente","talvez","agora"];

/* ============================================================
   REALIZAÇÃO (plano da expressão guiado pelo modo fonográfico)
============================================================ */
function realize(key){
  const mode = phMode();
  const row = LEX[key];
  if(!row) return key;
  if(mode==="surda") return row.surda;
  if(mode==="sonora") return row.sonora;
  return row.fricativa;
}

/* ============================================================
   GERADOR DE TEXTO (voz curatorial) — maior em M1/M3/M4
============================================================ */
function maybeAdj(){
  const p = clamp(0.18 + Math.abs(G.dense)*0.40 + Math.abs(G.front)*0.20, 0.10, 0.75);
  if(Math.random()>p) return null;
  const pool = (Math.abs(G.cont)>0.25) ? ADJ_S.concat(ADJ_P) : ADJ_P.concat(ADJ_C);
  return realize(pick(pool));
}
function maybeAdv(){
  const p = clamp(0.14 + Math.abs(G.cont)*0.35 + Math.abs(G.pressure)*0.10, 0.08, 0.60);
  if(Math.random()>p) return null;
  return realize(pick(ADV));
}
function Npick(pool, r){ return realize(r ? pickR(pool, r) : pick(pool)); }
function Vpick(pool, r){ return realize(r ? pickR(pool, r) : pick(pool)); }

function genCuratorialParagraph(kind){
  const nA = (G.front>0.25) ? Npick(N_CUR) : Npick(N_SENS);
  const nB = (G.dense>0.25) ? Npick(N_PLAS) : Npick(N_MEM);
  const nC = (G.cont>0.20) ? Npick(N_SENS) : Npick(N_CUR);

  const vA = (G.cont>0.15) ? Vpick(V_SENS) : Vpick(V_COMP);

  const adj1 = maybeAdj();
  const adv1 = maybeAdv();

  const T = [];

  if(kind==="m1"){
    T.push(`No começo, ${nA}${adj1?(" "+adj1):""} aparece como eixo — e isso já inclina o campo.`);
    T.push(`O que nasce aqui ${vA} ${nB}${adv1?(", "+adv1):""}.`);
    T.push(`O resto não some: fica como ${Npick(N_MEM)} à espera de outra tensão.`);
    T.push(`Se o campo endurece, não é ruído: é ${Npick(["tensao","configuracao","cessacao"])} em formação.`);
    return T.join(" ");
  }

  if(kind==="m3"){
    T.push(`Onde tocas, ${nC} ganha relevo; onde evitas, ${Npick(N_CUR)} recua.`);
    T.push(`Insistir em ${Npick(N_PLAS)} faz ${Npick(N_SENS)} responder como estilo.`);
    T.push(`Aos poucos, a tua curadoria deixa de “escolher imagens” e começa a formar campo.`);
    T.push(`${Npick(["presenca","tensao","configuracao"])} não é tema: é consequência do teu gesto.`);
    return T.join(" ");
  }

  if(kind==="m4"){
    const mode = phMode();
    const label = (mode==="surda") ? "plosivas surdas (corte seco)" :
                  (mode==="sonora") ? "plosivas sonoras (massa e peso)" :
                  "fricativas (passagem e arranho)";
    T.push(`O regime atual: ${label}.`);
    T.push(`Quando repetes um corpo, o resto do campo se reescreve junto — até ceder.`);
    T.push(`Se satura, não é bug: é ${Npick(["cessacao","resto","intervalo"])} como evento.`);
    return T.join(" ");
  }

  return "";
}

/* ============================================================
   M2 — S–V–O (restrito) + regras estritas
============================================================ */
const M2_VERBS = [
  ...V_COMP, ...V_SENS, ...V_DEC
];

function m2InitIfNeeded(){
  if(Mob.m2.subjKey && Mob.m2.objKey && Mob.m2.verbKey) return;

  const subj = (G.front>0.22) ? pick(N_CUR) : pick(N_SENS);
  const obj  = (G.dense>0.22) ? pick(N_PLAS) : pick(N_MEM);
  Mob.m2.subjKey = subj;
  Mob.m2.objKey  = obj;

  Mob.m2.verbIx = (Math.random()*M2_VERBS.length)|0;
  Mob.m2.verbKey = M2_VERBS[Mob.m2.verbIx];
}

function m2Block(nKey){
  const n = realize(nKey);
  const adjProb = clamp(0.22 + Math.abs(G.dense)*0.32 + Math.abs(G.front)*0.18, 0.18, 0.68);
  const advProb = clamp(0.12 + Math.abs(G.cont)*0.26, 0.10, 0.52);
  const adj = (Math.random()<adjProb) ? maybeAdj() : null;
  const adv = (Math.random()<advProb) ? maybeAdv() : null;

  let s = n;
  if(adj) s += " " + adj;
  if(adv) s += " " + adv;
  return s;
}


function m2ChooseVerb(subjKey, objKey){
  // escolhe um verbo coerente com a relação (determinístico por estado)
  // e sensível aos vetores globais (corte/fluxo, densidade).
  const s = `${subjKey}|${objKey}|${Math.round(G.front*10)}|${Math.round(G.cont*10)}|${Math.round(G.dense*10)}`;
  const r = mulberry32(hashStr(s));
  // se o campo está mais “corte”, favorece verbos de decisão; se “fluxo”, verbos de gesto/percepção
  const prefer = (G.cont < -0.12) ? V_DEC : (G.cont > 0.12) ? V_SENS : V_COMP;
  const pool = prefer.concat(M2_VERBS);
  return pickR(pool, r);
}
function renderM2Text(){
  m2InitIfNeeded();
  const el = document.getElementById("m2Text");
  el.innerHTML = "";

  const subjKey = Mob.m2.flip ? Mob.m2.objKey : Mob.m2.subjKey;
  const objKey  = Mob.m2.flip ? Mob.m2.subjKey : Mob.m2.objKey;

  const block1 = m2Block(subjKey);
  const block3 = m2Block(objKey);

  const s1 = document.createElement("span");
  s1.className="lock";
  s1.textContent = block1 + " ";

  const sv = document.createElement("span");
  sv.className="w verb";
  sv.textContent = realize(Mob.m2.verbKey) + " ";
  sv.addEventListener("click", (e)=>{ e.stopPropagation(); doM2VerbClick(); });

  const s3 = document.createElement("span");
  s3.className="lock";
  s3.textContent = block3 + ".";

  el.appendChild(s1);
  el.appendChild(sv);
  el.appendChild(s3);
}

/* regra: inverter só troca posições; não reamostra */
function doM2Swap(){
  Mob.m2.flip = !Mob.m2.flip;

  // ao inverter sujeito/objeto (via frente↔fundo), o verbo deve ajustar-se à nova relação
  const subjKey = Mob.m2.flip ? Mob.m2.objKey : Mob.m2.subjKey;
  const objKey  = Mob.m2.flip ? Mob.m2.subjKey : Mob.m2.objKey;
  Mob.m2.verbKey = m2ChooseVerb(subjKey, objKey);

  applyDelta({ front: (Mob.m2.flip? -0.08:+0.08), pressure: 0.03, cont:rnd(-0.02,0.02) });
  rerenderM2();
}

/* regra: clicar no verbo muda SOMENTE o objeto (bloco 3) */
function doM2VerbClick(){
  // Clicar no verbo: muda EXCLUSIVAMENTE o objeto (bloco 3) e o fragmento que o representa.
  Mob.m2.verbIx = (Mob.m2.verbIx + 1) % M2_VERBS.length;
  Mob.m2.verbKey = M2_VERBS[Mob.m2.verbIx];

  const pool = (G.dense>0.18) ? N_PLAS.concat(N_MEM) : N_MEM.concat(N_SENS);

  // qual lado está ocupando o objeto AGORA?
  const objectIsSubjSide = !!Mob.m2.flip; // se flip=true, o objeto exibido é o antigo sujeito (lado A)
  const newObjKey = pick(pool);

  if(objectIsSubjSide){
    Mob.m2.subjKey = newObjKey;
  }else{
    Mob.m2.objKey  = newObjKey;
  }

  // fragmento do objeto: reamostra apenas o slot do objeto (lado correspondente)
  if(Mob.m2.slots && Mob.m2.slots.length===2){
    const r = mulberry32(hashStr(`m2obj|${newObjKey}|${Math.round(G.dense*10)}|${Mob.m2.verbKey}|${Mob.m2.flip?1:0}`));
    const candidate = pickR(FIELD.slots, r);
    const objSlot = candidate || (objectIsSubjSide ? Mob.m2.slots[0] : Mob.m2.slots[1]);

    if(objectIsSubjSide){
      Mob.m2.slots[0] = objSlot; // lado A
    }else{
      Mob.m2.slots[1] = objSlot; // lado B
    }

    if(objSlot && objSlot.sui && !objSlot._img){ preloadSlotImage(objSlot, ()=>rerenderOne("m2")); }
  }

  // após alterar objeto, o verbo pode ajustar-se levemente ao par atual (sem mexer no sujeito)
  const subjKeyNow = Mob.m2.flip ? Mob.m2.objKey : Mob.m2.subjKey;
  const objKeyNow  = Mob.m2.flip ? Mob.m2.subjKey : Mob.m2.objKey;
  Mob.m2.verbKey = m2ChooseVerb(subjKeyNow, objKeyNow);

  applyDelta({ pressure: 0.06, dense:rnd(-0.04,0.04), cont:rnd(-0.04,0.04) });
  rerenderM2();
}

/* ============================================================
   DESENHO (cenários + slots)
============================================================ */
function drawScene(ctx, key, W, H){
  ctx.clearRect(0,0,W,H);

  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,.22)";
  ctx.fillRect(0,0,W,H);
  ctx.restore();

  const g1 = ctx.createRadialGradient(W*0.20,H*0.20,20, W*0.20,H*0.20, W*0.70);
  g1.addColorStop(0,"rgba(255,170,210,.28)");
  g1.addColorStop(1,"rgba(255,170,210,0)");
  ctx.fillStyle=g1; ctx.fillRect(0,0,W,H);

  const g2 = ctx.createRadialGradient(W*0.75,H*0.18,30, W*0.75,H*0.18, W*0.72);
  g2.addColorStop(0,"rgba(170,215,255,.26)");
  g2.addColorStop(1,"rgba(170,215,255,0)");
  ctx.fillStyle=g2; ctx.fillRect(0,0,W,H);

  ctx.save();
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(24,19,21,.22)";
  ctx.fillStyle = "rgba(255,255,255,.10)";

  if(key==="m1"){
    ctx.beginPath();
    ctx.moveTo(W*0.10,H*0.18);
    ctx.quadraticCurveTo(W*0.50,H*0.04, W*0.90,H*0.18);
    ctx.stroke();
    [0.18,0.50,0.82].forEach(x=>{
      ctx.beginPath();
      ctx.moveTo(W*x,H*0.18);
      ctx.lineTo(W*x,H*0.34);
      ctx.stroke();
    });
  }
  if(key==="m2"){
    ctx.beginPath();
    ctx.moveTo(0,H*0.58);
    ctx.lineTo(W*0.20,H*0.42);
    ctx.lineTo(W*0.38,H*0.58);
    ctx.lineTo(W*0.55,H*0.36);
    ctx.lineTo(W*0.76,H*0.58);
    ctx.lineTo(W,H*0.46);
    ctx.lineTo(W,H);
    ctx.lineTo(0,H);
    ctx.closePath();
    ctx.fillStyle="rgba(255,255,255,.12)";
    ctx.fill();
    ctx.strokeStyle="rgba(24,19,21,.18)";
    ctx.stroke();

    ctx.strokeStyle="rgba(24,19,21,.20)";
    for(let i=0;i<7;i++){
      const x = W*(0.12 + i*0.12) + rnd(-8,8);
      const y = H*(0.70 + rnd(-0.02,0.02));
      ctx.beginPath();
      ctx.moveTo(x,y);
      ctx.lineTo(x+8,y-3);
      ctx.lineTo(x+14,y);
      ctx.stroke();
    }
  }
  if(key==="m3"){
    ctx.strokeStyle="rgba(24,19,21,.18)";
    for(let y=0;y<7;y++){
      for(let x=0;x<11;x++){
        if(Math.random()<0.35){
          ctx.strokeRect(W*0.05 + x*(W*0.085), H*0.10 + y*(H*0.11), W*0.075, H*0.095);
        }
      }
    }
  }
  if(key==="m4"){
    ctx.strokeStyle="rgba(24,19,21,.20)";
    const steps=10;
    for(let i=0;i<steps;i++){
      const x = W*0.12 + i*(W*0.06);
      const y = H*0.65 - i*(H*0.04);
      ctx.strokeRect(x,y, W*0.12, H*0.06);
    }
    for(let i=0;i<steps;i++){
      const x = W*0.55 + i*(W*0.03);
      const y = H*0.28 + i*(H*0.05);
      ctx.strokeRect(x,y, W*0.14, H*0.06);
    }
  }
  ctx.restore();
}

function slotFamily(slot){
  const n = parseInt((slot.fam||"F1").replace("F",""),10);
  return isNaN(n)?1:n;
}

async function preloadSlotImage(slot, onload){
  if(!slot.sui) return;
  if(slot._img) return;

  const img = new Image();
  img.crossOrigin = "anonymous";

  let tried = 0;
  const load = () => {
    tried++;
    img.src = tried === 1 ? (slot.sui.path + "?v=" + Date.now()) : slot.sui.path;
  };

  img.onload = onload;
  img.onerror = () => {
    if(tried < 2){
      load();
      return;
    }
    console.warn("Falha ao carregar imagem da Sui:", slot.sui.path);
  };

  slot._img = img;
  load();
}

function drawProcedural(ctx, slot, x,y,w,h){
  const fam = slotFamily(slot);
  ctx.save();
  ctx.translate(x,y);

  ctx.fillStyle = "rgba(255,255,255,.55)";
  ctx.fillRect(0,0,w,h);

  ctx.fillStyle = "rgba(40,30,38,.07)";
  ctx.fillRect(0,0,w,h);

  const hue = (fam*27 + slot.v*11) % 360;
  ctx.fillStyle = `hsla(${hue}, 65%, 80%, 0.26)`;
  ctx.fillRect(0,0,w,h);

  ctx.strokeStyle = "rgba(24,19,21,.30)";
  ctx.lineWidth = 2;

  if(fam===1){
    for(let i=0;i<6;i++){
      ctx.beginPath();
      ctx.moveTo(0, h*(0.15+i*0.14));
      ctx.lineTo(w, h*(0.15+i*0.14)+rnd(-6,6));
      ctx.stroke();
    }
  } else if(fam===2){
    for(let i=0;i<5;i++){
      const xx = w*(0.18+i*0.16)+rnd(-6,6);
      ctx.beginPath();
      ctx.moveTo(xx,0);
      ctx.lineTo(xx,h);
      ctx.stroke();
    }
  } else if(fam===3){
    ctx.beginPath();
    ctx.moveTo(w*0.1,h*0.8);
    ctx.lineTo(w*0.9,h*0.2);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(w*0.15,h*0.55);
    ctx.lineTo(w*0.85,h*0.15);
    ctx.stroke();
  } else if(fam===4){
    for(let i=0;i<7;i++){
      ctx.beginPath();
      ctx.arc(w*(0.15+i*0.12), h*(0.55+rnd(-0.08,0.08)), 9+rnd(-3,3), 0, Math.PI*2);
      ctx.stroke();
    }
  } else if(fam===5){
    ctx.beginPath();
    ctx.moveTo(w*0.1,h*0.1);
    ctx.lineTo(w*0.9,h*0.9);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(w*0.9,h*0.1);
    ctx.lineTo(w*0.1,h*0.9);
    ctx.stroke();
  } else if(fam===6){
    for(let i=0;i<10;i++){
      ctx.fillStyle = `rgba(24,19,21,${0.04+rnd(0,0.06)})`;
      ctx.fillRect(rnd(0,w), rnd(0,h), rnd(18,60), rnd(12,48));
    }
  } else if(fam===7){
    ctx.fillStyle="rgba(255,255,255,.62)";
    ctx.fillRect(0,0,w,h);
    ctx.strokeStyle="rgba(24,19,21,.18)";
    ctx.strokeRect(w*0.10,h*0.18,w*0.80,h*0.64);
  } else if(fam===8){
    ctx.beginPath();
    ctx.strokeRect(w*0.18+rnd(-10,10), h*0.18+rnd(-10,10), w*0.64, h*0.64);
  } else if(fam===9){
    ctx.fillStyle="rgba(24,19,21,.06)";
    for(let i=0;i<60;i++){
      ctx.fillRect(rnd(0,w), rnd(0,h), 2, 2);
    }
  } else if(fam===10){
    ctx.beginPath();
    ctx.moveTo(w*0.15,h*0.25);
    ctx.lineTo(w*0.85,h*0.25);
    ctx.lineTo(w*0.50,h*0.85);
    ctx.closePath();
    ctx.stroke();
  } else if(fam===11){
    ctx.beginPath();
    ctx.strokeRect(w*0.12,h*0.12,w*0.76,h*0.76);
    ctx.beginPath();
    ctx.strokeRect(w*0.22,h*0.22,w*0.56,h*0.56);
  } else {
    ctx.fillStyle="rgba(24,19,21,.10)";
    ctx.fillRect(w*0.15,h*0.18,w*0.70,h*0.62);
  }

  ctx.restore();
}

function drawSlot(ctx, slot, x,y,w,h){
  ctx.save();
  ctx.shadowColor="rgba(0,0,0,.12)";
  ctx.shadowBlur=18;
  ctx.shadowOffsetY=10;

  ctx.fillStyle="rgba(255,255,255,.60)";
  ctx.fillRect(x,y,w,h);

  ctx.shadowColor="transparent";
  ctx.lineWidth=3;
  ctx.strokeStyle="rgba(24,19,21,.34)";
  ctx.strokeRect(x,y,w,h);

  if(slot.sui && slot._img && slot._img.complete && slot._img.naturalWidth){
    ctx.save();
    ctx.beginPath();
    ctx.rect(x+3,y+3,w-6,h-6);
    ctx.clip();
    // draw as "cover" (preserve aspect ratio, no squish)
    const iw = slot._img.naturalWidth;
    const ih = slot._img.naturalHeight;
    const tw = (w-6), th = (h-6);
    const scale = Math.max(tw/iw, th/ih);
    const dw = iw * scale;
    const dh = ih * scale;
    const dx = (x+3) + (tw - dw)/2;
    const dy = (y+3) + (th - dh)/2;
    ctx.drawImage(slot._img, dx, dy, dw, dh);
    ctx.restore();
  } else {
    drawProcedural(ctx, slot, x+3,y+3,w-6,h-6);
  }

  ctx.restore();
}

/* ============================================================
   DRAW MOBILE (com cache de slots por móbile)
============================================================ */
const HITS = { m1:[], m2:[], m3:[], m4:[], final:[] };

async function drawMobile(canvas, key, count){
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  drawScene(ctx, key, W, H);

  if(!Mob[key].slots){
    let slots = sampleSlots(count);
    slots = ensureSui(slots);
    Mob[key].slots = slots;
  }
  const slots = Mob[key].slots;

  for(const s of slots){
    if(s.sui && !s._img){
      await preloadSlotImage(s, ()=>{ rerenderOne(key); });
    }
  }

  const hits = [];
  if(key==="m1"){
    const w = W*0.22, h = H*0.30;
    const xs = [W*0.18, W*0.50, W*0.82];
    const ys = [H*0.42, H*0.42, H*0.42];
    for(let i=0;i<3;i++){
      const x = xs[i]-w/2;
      const y = ys[i]-h/2;
      drawSlot(ctx, slots[i], x,y,w,h);
      hits.push({x,y,w,h,slot:slots[i]});
    }
  } else if(key==="m2"){
    const bigW=W*0.36, bigH=H*0.42;
    const smallW=W*0.26, smallH=H*0.30;

    const a = slots[0];
    const b = slots[1];

    const frontSlot = Mob.m2.flip ? b : a;
    const backSlot  = Mob.m2.flip ? a : b;

    let xB=W*0.66 - smallW/2;
    let yB=H*0.48 - smallH/2;
    drawSlot(ctx, backSlot, xB,yB,smallW,smallH);
    hits.push({x:xB,y:yB,w:smallW,h:smallH,slot:backSlot, role:"back"});

    let xF=W*0.30 - bigW/2;
    let yF=H*0.60 - bigH/2;
    drawSlot(ctx, frontSlot, xF,yF,bigW,bigH);
    hits.push({x:xF,y:yF,w:bigW,h:bigH,slot:frontSlot, role:"front"});
  } else if(key==="m3"){
    const baseW=W*0.18, baseH=H*0.24;
    for(let i=0;i<7;i++){
      const s=slots[i];
      const x = W*(0.10 + (i%4)*0.20) + rnd(-14,14);
      const y = H*(0.18 + Math.floor(i/4)*0.34) + rnd(-10,10);
      const w = baseW * (0.92 + (s.axes.front+1)*0.14);
      const h = baseH * (0.92 + (s.axes.dense+1)*0.12);
      drawSlot(ctx, s, x, y, w, h);
      hits.push({x,y,w,h,slot:s});
    }
  } else if(key==="m4"){
    const baseW=W*0.20, baseH=H*0.22;
    const pad = W*0.06;
    const gap = (W - 2*pad - 5*baseW) / 4;
    for(let i=0;i<5;i++){
      const s=slots[i];
      let x = pad + i*(baseW+gap) + rnd(-8,8);
      let y = H*(0.22 + (i%2)*0.22) + rnd(-8,8);
      const w = baseW * (0.92 + (s.axes.front+1)*0.12);
      const h = baseH * (0.92 + (s.axes.dense+1)*0.10);
      // clamp to avoid cutting on the right
      x = clamp(x, pad*0.6, W - w - pad*0.6);
      y = clamp(y, H*0.10, H - h - H*0.08);
      drawSlot(ctx, s, x, y, w, h);
      hits.push({x,y,w,h,slot:s});
    }
  } else if(key==="final"){
    const baseW=W*0.19, baseH=H*0.22;
    const pad = W*0.06;
    const gap = (W - 2*pad - 5*baseW) / 4;
    for(let i=0;i<10;i++){
      const s=slots[i];
      const col = (i%5);
      const row = Math.floor(i/5);
      let x = pad + col*(baseW+gap) + rnd(-8,8);
      let y = H*(0.16 + row*0.34) + rnd(-8,8);
      const w = baseW * (0.92 + (s.axes.front+1)*0.14);
      const h = baseH * (0.92 + (s.axes.dense+1)*0.12);
      x = clamp(x, pad*0.6, W - w - pad*0.6);
      y = clamp(y, H*0.06, H - h - H*0.06);
      drawSlot(ctx, s, x, y, w, h);
      hits.push({x,y,w,h,slot:s});
    }
  }

  HITS[key] = hits;
}

/* ============================================================
   TEXT RENDER (restrições por móbile)
============================================================ */
function setTextPlain(el, text){
  el.textContent = text;
}

function setTextInteractive(el, text){
  el.innerHTML = "";
  const parts = text.split(/\s+/).filter(Boolean);
  for(const p of parts){
    const span = document.createElement("span");
    span.className="w";
    span.textContent = p + " ";
    el.appendChild(span);
  }
}

/* ============================================================
   RERENDER por partes
============================================================ */
async function rerenderOne(key){
  if(key==="m1") return rerenderM1();
  if(key==="m2") return rerenderM2();
  if(key==="m3") return rerenderM3();
  if(key==="m4") return rerenderM4();
  if(key==="final") return rerenderFinal();
}

async function rerenderM1(){
  await drawMobile(document.getElementById("m1Canvas"), "m1", 3);
  setTextPlain(document.getElementById("m1Text"), genCuratorialParagraph("m1"));
}

async function rerenderM2(){
  await drawMobile(document.getElementById("m2Canvas"), "m2", 2);
  renderM2Text();
}

async function rerenderM3(){
  await drawMobile(document.getElementById("m3Canvas"), "m3", 7);
  setTextInteractive(document.getElementById("m3Text"), genCuratorialParagraph("m3"));
}

async function rerenderM4(){
  await drawMobile(document.getElementById("m4Canvas"), "m4", 5);
  setTextInteractive(document.getElementById("m4Text"), genCuratorialParagraph("m4"));
}

async function rerenderFinal(){
  await drawMobile(document.getElementById("finalCanvas"), "final", 10);

  try{
    const seed = Mob.final.seed ?? finalSeed();
    const A = Mob.final.textA ?? buildFinalA(seed);
    const B = Mob.final.textB ?? buildFinalB(seed);

    const shareInvite =
`Partilha a tua exposição.
Cada percurso faz emergir obras diferentes.
Outras pessoas verão imagens que talvez nunca tenhas conseguido alcançar.

E você — o que montaria aqui?
${location.href}`;

    const full = `${A}

${B}

${TEXT_FINAL_CLOSING}

${shareInvite}`;
    const el = document.getElementById("finalText");
    el.textContent = full;

    // garante visibilidade (alguns browsers/mobiles podem colapsar o bloco)
    document.getElementById("finalShare").style.display = "inline-flex";
    el.style.display = "block";
  }catch(e){
    console.error(e);
    const el = document.getElementById("finalText");
    el.style.display = "block";
    el.textContent = "Houve um erro ao gerar o texto da exposição — mas a constelação visual foi gerada. (Abre a consola para detalhes.)";
  }

  document.getElementById("weeklyGate").textContent =
`Para ver os demais estados expositivos da semana, faz primeiro a tua curadoria (gera a tua expo).`;
}

async function rerenderAll(){
  await rerenderM1();
  await rerenderM2();
  await rerenderM3();
  await rerenderM4();
  if(Mob.final.ready) await rerenderFinal();
}

/* ============================================================
   FINAL TEXTS (duas partes)
============================================================ */
function buildFinalA(seed){
  const r = mulberry32(seed>>>0);

  const pFront = (G.front>0.25) ? "frente / figura" : (G.front<-0.25) ? "fundo / atmosfera" : "equilíbrio de planos";
  const pDense = (G.dense>0.25) ? "densidade e peso" : (G.dense<-0.25) ? "rarefação e respiro" : "densidade contida";
  const pCont  = (G.cont>0.25)  ? "continuidade e fluxo" : (G.cont<-0.25) ? "corte e decisão" : "passagens cautelosas";

  const pm = phMode();
  const pPh = (pm==="surda") ? "corte seco (plosivas surdas)"
            : (pm==="sonora") ? "massa/peso (plosivas sonoras)"
            : "passagem (fricativas)";

  const opener = pickR([
    "O teu estilo curatorial não é neutro.",
    "O que fizeste aqui desenha um perfil curatorial.",
    "O percurso que montaste deixa uma assinatura.",
  ], r);

  return `${opener} Inclina-se para ${pFront}, com ${pDense}. Predomina ${pCont}, sob um corpo sonoro de ${pPh}.`;
}

function buildFinalB(seed){
  const r = mulberry32((seed+1337)>>>0);

  const n1 = realize(pickR(N_PLAS, r));
  const n2 = realize(pickR(N_SENS, r));
  const n3 = realize(pickR(N_MEM, r));
  const v1 = realize(pickR(V_COMP, r));
  const v2 = realize(pickR(V_SENS.concat(V_DEC), r));

  const a1 = (r()<0.55) ? realize(pickR(ADJ, r)) : null;
  const a2 = (r()<0.45) ? realize(pickR(ADJ, r)) : null;
  const adv1 = (r()<0.55) ? realize(pickR(ADV, r)) : null;

  const seg1 = `A exposição resultante ${v1} ${n1}${a1?` ${a1}`:""} num campo onde ${n2} aparece como ${n3}.`;
  const seg2 = `O que fica à vista organiza-se por ${G.cont<0? "decisão e recorte" : "passagem e aproximação"}, e o que recua sustenta um resto que não se fecha.`;
  const seg3 = `${adv1?adv1.charAt(0).toUpperCase()+adv1.slice(1):"Ainda"} assim, o conjunto ${v2} o olhar: pede retorno, comparação, reentrada — como se cada constelação guardasse outras que não emergiram.`;

  return [seg1, seg2, seg3].join(" ");
}

function buildFinalText(){
  return `${buildFinalA()}\n\n${buildFinalB()}`;
}

/* ============================================================
   INTERAÇÕES (restritas como combinado)
============================================================ */
function bindCanvasClicks(key, canvas){
  canvas.addEventListener("click", (ev)=>{
    if(key==="m1" || key==="m4" || key==="final") return;

    const r = canvas.getBoundingClientRect();
    const x = (ev.clientX - r.left) * (canvas.width / r.width);
    const y = (ev.clientY - r.top)  * (canvas.height/ r.height);
    const hits = HITS[key] || [];
    const hit = hits.find(h => x>=h.x && x<=h.x+h.w && y>=h.y && y<=h.y+h.h);
    if(!hit) return;

    try{
      if(key==="m2"){ if(hit.role==="front"||hit.role==="back"){ doM2Swap(); } return; }

      if(key==="m3"){
        const slot = hit.slot;
        const fam = slotFamily(slot);

        Mob.m3.focusFam = fam;
        Mob.m3.intensity = clamp(Mob.m3.intensity + 0.14, 0, 1);
        Mob.m3.clicks++;

        applyDelta({
          pressure: 0.03,
          cont: (fam===1||fam===4||fam===7) ? +0.05 : -0.02,
          dense:(fam===6||fam===12) ? +0.05 : 0.00,
          front:(fam===2||fam===5) ? +0.05 : 0.00
        });

        if(Mob.m3.intensity >= 0.98){
          Mob.m3.intensity = 0;
          Mob.m3.focusFam = null;
          Mob.m3.slots = null;
          toast("M3: catástrofe — nova configuração.");
        }

        rerenderM3();
        rerenderM4();
        return;
      }
    }catch(e){
      console.error(e);
      toast("Erro no clique (ver consola).");
    }
  });
}

function bindTextClicks(key, textEl){
  textEl.addEventListener("click", (ev)=>{
    const t = ev.target;
    if(!t || !t.classList || !t.classList.contains("w")) return;

    try{
      if(key==="m3"){
        const axe = (Math.abs(G.cont)>Math.abs(G.front) && Math.abs(G.cont)>Math.abs(G.dense)) ? "cont"
                  : (Math.abs(G.dense)>Math.abs(G.front)) ? "dense" : "front";

        Mob.m3.intensity = clamp(Mob.m3.intensity + 0.12, 0, 1);

        const delta = { front:0, dense:0, cont:0, pressure:0.025 };
        delta[axe] = 0.06;
        applyDelta(delta);

        if(Mob.m3.intensity >= 0.98){
          Mob.m3.intensity = 0;
          Mob.m3.focusFam = null;
          Mob.m3.slots = null;
          toast("M3: catástrofe — nova configuração.");
        }

        rerenderM3();
        rerenderM4();
        return;
      }

      if(key==="m4"){
        Mob.m4.intensity = clamp(Mob.m4.intensity + 0.14, 0, 1);
        Mob.m4.clicks++;

        const mode = phMode();
        if(mode==="surda") applyDelta({ ph:{dry:+0.30}, pressure:+0.04, cont:-0.02 });
        else if(mode==="sonora") applyDelta({ ph:{voiced:+0.30}, pressure:+0.04, dense:+0.02 });
        else applyDelta({ ph:{open:+0.30}, pressure:+0.04, cont:+0.02 });

        if(Mob.m4.intensity >= 0.98){
          Mob.m4.intensity = 0;
          Mob.m4.focusPh = null;
          Mob.m4.slots = null;
          toast("M4: colapso — o corpo sonoro virou regime.");
        }

        rerenderM4();
        return;
      }
    }catch(e){
      console.error(e);
      toast("Erro no texto (ver consola).");
    }
  });
}

/* ============================================================
   BOTÕES / SHARE
============================================================ */

async function shareDirect(text, srcCanvasId){
  if(!navigator.share) return false;
  const src = document.getElementById(srcCanvasId);
  try{
    const blob = await new Promise((resolve)=> src.toBlob(resolve, "image/png"));
    const file = new File([blob], "mobiles.png", {type:"image/png"});
    if(navigator.canShare && !navigator.canShare({files:[file]})) return false;
    await navigator.share({ title:"MÓBILES", text, files:[file] });
    return true;
  }catch(e){
    return false;
  }
}
function openShare(title, note, text, srcCanvasId){
  document.getElementById("shareTitle").textContent = title;
  document.getElementById("shareNote").textContent = note;
  document.getElementById("shareText").value = text;

  const src = document.getElementById(srcCanvasId);
  const out = document.getElementById("shareCanvas");
  const ctx = out.getContext("2d");

  ctx.clearRect(0,0,out.width,out.height);
  ctx.fillStyle = "rgba(255,255,255,.94)";
  ctx.fillRect(0,0,out.width,out.height);

  ctx.fillStyle = "rgba(24,19,21,.88)";
  ctx.font = "900 22px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("MÓBILES — suiornotsui", 42, 48);

  ctx.fillStyle = "rgba(24,19,21,.55)";
  ctx.font = "14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(new Date().toISOString().slice(0,19).replace("T"," "), 42, 72);

  const pad = 42;
  const targetW = out.width - pad*2;
  const ratio = src.height / src.width;
  const targetH = Math.min(out.height*0.56, targetW*ratio);
  const dx = pad;
  const dy = 96;
  ctx.drawImage(src, dx, dy, targetW, targetH);

  const textTop = dy + targetH + 46;
  ctx.fillStyle = "rgba(24,19,21,.82)";
  ctx.font = "16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";

  const lines = text.split("\n").join(" ").split(/(?<=\.)\s+/).slice(0,10);
  let y = textTop;
  for(const ln of lines){
    const s = ln.trim();
    if(!s) continue;
    wrapLine(ctx, s, pad, y, out.width - pad*2, 22);
    y += 28;
    if(y>out.height-40) break;
  }

  document.getElementById("overlay").style.display="flex";
}

function wrapLine(ctx, text, x, y, maxWidth, lineHeight){
  const words = text.split(" ");
  let line = "";
  for(let n=0;n<words.length;n++){
    const test = line + words[n] + " ";
    if(ctx.measureText(test).width > maxWidth && n>0){
      ctx.fillText(line, x, y);
      line = words[n] + " ";
      y += lineHeight;
    } else {
      line = test;
    }
  }
  ctx.fillText(line, x, y);
}

function closeShare(){ document.getElementById("overlay").style.display="none"; }
window.closeShare = closeShare;

function canvasToDataURL(canvas){
  try{ return canvas.toDataURL("image/png"); }catch(e){ return ""; }
}

function shareTextFor(kind){
  const link = location.href;

  // texto gerado (prioridade absoluta)
  let generated = "";
  if(kind==="m1") generated = (document.getElementById("m1Text")?.innerText || "").trim();
  if(kind==="m2") generated = (document.getElementById("m2Text")?.innerText || "").trim();
  if(kind==="m3") generated = (document.getElementById("m3Text")?.innerText || "").trim();
  if(kind==="m4") generated = (document.getElementById("m4Text")?.innerText || "").trim();
  if(kind==="final") generated = (document.getElementById("finalText")?.innerText || "").trim();

  const titleMap = {
    m1: "Móbile 1",
    m2: "Móbile 2",
    m3: "Móbile 3",
    m4: "Móbile 4",
    final: "Exposição final"
  };
  const header = `${titleMap[kind]||"MÓBILES"} — curadoria gerada`;

  // manifesto curto (explica sem didatismo, chama sem marketing)
  const manifesto =
`MÓBILES é uma máquina curatorial interativa desenvolvida a partir do trabalho de @suiornotsui.
Aqui, não vês tudo: o que aparece depende do modo como cada pessoa toca, insiste, escolhe e atravessa o campo.

Cada gesto constrói uma curadoria singular.
E deixa sempre um resto invisível — aquilo que ainda não foi alcançado.

Faz a tua própria exposição:`;

  // fallback se ainda não há texto gerado (primeiro carregamento / erro)
  if(!generated){
    generated = "Uma curadoria provisória apareceu — mas nunca é toda. O resto insiste.";
  }

  return `${header}

${generated}

${manifesto}
${link}`;
}

function bindButtons(){
  document.getElementById("m1Tension").addEventListener("click", ()=>{
    G.birthMode = (G.birthMode + 1) % 3;
    if(G.birthMode===0){
      applyDelta({ front:rnd(-0.25,0.25), dense:rnd(-0.15,0.15), cont:+0.20, ph:{open:+0.12}, pressure:0.10 });
    }else if(G.birthMode===1){
      applyDelta({ front:+0.28, dense:+0.10, cont:-0.25, ph:{dry:+0.16}, pressure:0.12 });
    }else{
      applyDelta({ front:-0.28, dense:-0.10, cont:+0.05, ph:{voiced:+0.16}, pressure:0.12 });
    }

    Mob.m1.slots=null;
    Mob.m2.slots=null; Mob.m2.subjKey=null; Mob.m2.objKey=null; Mob.m2.verbKey=null;
    Mob.m3.slots=null; Mob.m3.intensity=0;
    Mob.m4.slots=null; Mob.m4.intensity=0;
    Mob.final.slots=null;

    rerenderAll();
  });

  document.getElementById("m2Swap").addEventListener("click", doM2Swap);

  document.getElementById("btnFinalize").addEventListener("click", ()=>{
    // gera resultado FINAL determinístico a partir do estado atual (não muda a cada clique)
    Mob.final.ready = true;

    const seed = finalSeed();
    if(Mob.final.seed !== seed){
      Mob.final.seed = seed;
      Mob.final.rng  = mulberry32(seed);
      Mob.final.slots = ensureSui(sampleSlotsSeeded(10, seed));
      Mob.final.textA = buildFinalA(seed);
      Mob.final.textB = buildFinalB(seed);
    }
    rerenderFinal();
    toast("Exposição gerada.");
  });

  document.getElementById("m1Share").addEventListener("click", async ()=>{
    const t = shareTextFor("m1");
    if(!(await shareDirect(t, "m1Canvas"))){
      openShare("Partilhar — Móbile 1", "imagem + texto", t, "m1Canvas");
    }
  });
  document.getElementById("m2Share").addEventListener("click", async ()=>{
    const t = shareTextFor("m2");
    if(!(await shareDirect(t, "m2Canvas"))){
      openShare("Partilhar — Móbile 2", "imagem + texto", t, "m2Canvas");
    }
  });
  document.getElementById("m3Share").addEventListener("click", async ()=>{
    const t = shareTextFor("m3");
    if(!(await shareDirect(t, "m3Canvas"))){
      openShare("Partilhar — Móbile 3", "imagem + texto", t, "m3Canvas");
    }
  });
  document.getElementById("m4Share").addEventListener("click", async ()=>{
    const t = shareTextFor("m4");
    if(!(await shareDirect(t, "m4Canvas"))){
      openShare("Partilhar — Móbile 4", "imagem + texto", t, "m4Canvas");
    }
  });
  document.getElementById("finalShare").addEventListener("click", async ()=>{
    const t = shareTextFor("final");
    if(!(await shareDirect(t, "finalCanvas"))){
      openShare("Partilhar — Exposição", "imagem + texto", t, "finalCanvas");
    }
  });

  document.getElementById("copyTextBtn").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(document.getElementById("shareText").value);
      toast("Texto copiado.");
    }catch(e){
      toast("Não foi possível copiar.");
    }
  });

  document.getElementById("downloadBtn").addEventListener("click", ()=>{
    const c = document.getElementById("shareCanvas");
    const a = document.createElement("a");
    a.download = "mobiles.png";
    a.href = canvasToDataURL(c);
    a.click();
  });

  document.getElementById("nativeShareBtn").addEventListener("click", async ()=>{
    const text = document.getElementById("shareText").value;
    const c = document.getElementById("shareCanvas");
    if(!navigator.share){
      toast("Partilha nativa indisponível aqui.");
      return;
    }
    try{
      const blob = await (await fetch(c.toDataURL("image/png"))).blob();
      const file = new File([blob], "mobiles.png", {type:"image/png"});
      await navigator.share({ text, files:[file] });
    }catch(e){
      toast("Partilha cancelada ou indisponível.");
    }
  });
}

/* ============================================================
   BOOT
============================================================ */
async function boot(){
  // Prelude (I, II, III) – rendered as three readable blocks
  const lead = document.getElementById("leadText");
  lead.innerHTML = `
    <div class="prelude">
      <details class="docBlock" open>
        <summary>I</summary>
        <div class="docBody" id="docI"></div>
      </details>
      <details class="docBlock">
        <summary>II</summary>
        <div class="docBody" id="docII"></div>
      </details>
      <details class="docBlock">
        <summary>III</summary>
        <div class="docBody" id="docIII"></div>
      </details>
      <div class="docHint">Dica: abre/fecha os blocos acima para navegar o texto sem perder o fluxo da página.</div>
    </div>
  `;
  document.getElementById("docI").textContent = TEXT_I;
  document.getElementById("docII").textContent = TEXT_II;
  document.getElementById("docIII").textContent = TEXT_III;

  document.getElementById("introM1").textContent = INTRO_M1;
  document.getElementById("introM2").textContent = INTRO_M2;
  document.getElementById("introM3").textContent = INTRO_M3;
  document.getElementById("introM4").textContent = INTRO_M4;
  document.getElementById("closingText").textContent = TEXT_FINAL_CLOSING;
  document.getElementById("finalIntro").textContent = "Depois do último móbile, encerra — e gera a tua exposição.";

  buildField();
  await tryLoadSui();

  bindButtons();
  bindCanvasClicks("m1", document.getElementById("m1Canvas"));
  bindCanvasClicks("m2", document.getElementById("m2Canvas"));
  bindCanvasClicks("m3", document.getElementById("m3Canvas"));
  bindCanvasClicks("m4", document.getElementById("m4Canvas"));
  bindCanvasClicks("final", document.getElementById("finalCanvas"));

  bindTextClicks("m3", document.getElementById("m3Text"));
  bindTextClicks("m4", document.getElementById("m4Text"));

  updatePill();
  await rerenderAll();
}

boot();
</script>
</body>
</html>
