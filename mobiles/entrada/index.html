<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MÓBILES — Entrada</title>
<style>
  :root{
    --bg:#f4f2ee;
    --ink:rgba(10,10,12,.92);
    --muted:rgba(10,10,12,.60);
    --card:rgba(255,255,255,.62);
    --line:rgba(10,10,12,.14);
    --chip:rgba(10,10,12,.08);
    --chipOn:rgba(10,10,12,.18);
    --shadow: 0 10px 40px rgba(0,0,0,.08);
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: var(--bg);
    color: var(--ink);
  }
  .topbar{
    position: sticky; top:0; z-index:50;
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
    background: rgba(244,242,238,.78);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
  }
  .brand{font-weight:800; letter-spacing:.02em}
  .subtitle{font-size:12px; color:var(--muted); margin-top:2px}
  .left{display:flex; flex-direction:column}
  .right{display:flex; gap:10px; align-items:center}
  .pill{
    font-size:12px;
    padding:6px 10px;
    border:1px solid var(--line);
    border-radius:999px;
    color:var(--muted);
    background:rgba(255,255,255,.35);
  }
  .btn{
    appearance:none; border:1px solid var(--line);
    background:rgba(255,255,255,.55);
    padding:8px 10px; border-radius:12px;
    cursor:pointer;
    font-weight:650;
  }
  .btn:hover{ filter:brightness(.98) }
  main{ max-width: 1040px; margin: 16px auto 80px; padding: 0 14px; }
  .flow{ display:flex; flex-direction:column; gap: 18px; }
  .card{
    background: var(--card);
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .head{
    display:flex; justify-content:space-between; gap:10px;
    padding:14px 14px 12px;
    border-bottom:1px solid var(--line);
  }
  .t b{display:block; font-size:14px}
  .t small{display:block; font-size:12px; color:var(--muted); margin-top:2px; line-height:1.25}
  .mini{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .mini button{ font-size:12px; padding:7px 10px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.55); cursor:pointer; }
  .stage{ padding: 12px 14px 16px; }
  canvas{ width:100%; height:auto; display:block; border-radius:18px; background: rgba(255,255,255,.28); border:1px solid var(--line); }
  .text{ margin-top:10px; font-size:14px; line-height:1.45; }
  .line{ margin: 4px 0; }
  .word{
    cursor:pointer;
    display:inline-block;
    padding:2px 5px;
    border-radius:10px;
    margin: 0 1px;
  }
  .word:hover{ background: rgba(0,0,0,.06); }
  .hint{ margin-top:10px; font-size:12px; color:var(--muted); }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
  .chip{
    font-size:12px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background: var(--chip);
    cursor:pointer;
    user-select:none;
  }
  .chip.on{ background: var(--chipOn); font-weight:700; }
  .final .stage{ display:grid; grid-template-columns: 1.5fr .8fr; gap:12px; }
  .kpi{ display:grid; grid-template-columns: 1fr; gap:10px; }
  .box{
    padding:12px;
    border:1px solid var(--line);
    border-radius:18px;
    background: rgba(255,255,255,.42);
  }
  .box b{ display:block; font-size:12px }
  .box span{ display:block; margin-top:6px; color:var(--muted); font-size:12px }
  footer{ max-width:1040px; margin: 0 auto; padding: 0 14px 26px; color:var(--muted); font-size:12px; }
  dialog{
    border:none; border-radius:18px; padding:0;
    width:min(560px, 92vw);
    box-shadow: 0 20px 70px rgba(0,0,0,.22);
  }
  dialog::backdrop{ background: rgba(0,0,0,.35); }
  .dlgHead{ padding:14px 14px 12px; border-bottom:1px solid var(--line); background: rgba(244,242,238,.9); }
  .dlgBody{ padding:14px; background: rgba(255,255,255,.72); }
  .dlgBody pre{ white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:rgba(0,0,0,.75); }
  .dlgBtns{ display:flex; gap:10px; justify-content:flex-end; padding: 0 14px 14px; background: rgba(255,255,255,.72); }
</style>
</head>
<body>

<div class="topbar">
  <div class="left">
    <div class="brand">MÓBILES</div>
    <div class="subtitle">Entrada — operar curadoria como máquina (semântica + imagem + fonografia)</div>
  </div>
  <div class="right">
    <div class="pill" id="pillState">campo: —</div>
    <button class="btn" id="btnReset">Reset</button>
  </div>
</div>

<main>
  <section class="flow">

    <article class="card" id="cardM1">
      <div class="head">
        <div class="t">
          <b>Móbile 1 — Nascimento do campo</b>
          <small>3 fragmentos · o ponto de partida regula tudo o que poderá emergir depois</small>
        </div>
        <div class="mini">
          <button id="m1Tension">Tensionar nascimento</button>
          <button id="m1Share">Partilhar</button>
        </div>
      </div>
      <div class="stage">
        <canvas id="m1Canvas" width="980" height="520"></canvas>
        <div class="text" id="m1Text"></div>
        <div class="hint">Aqui você decide “de onde nasce”: a máquina vai resistir/ceder conforme esse começo.</div>
      </div>
    </article>

    <article class="card" id="cardM2">
      <div class="head">
        <div class="t">
          <b>Móbile 2 — Sintaxe (sujeito ↔ objeto)</b>
          <small>2 fragmentos · inverter frente/fundo inverte sujeito/objeto; clicar no verbo abre fuga</small>
        </div>
        <div class="mini">
          <button id="m2Swap">Inverter</button>
          <button id="m2Share">Partilhar</button>
        </div>
      </div>
      <div class="stage">
        <canvas id="m2Canvas" width="980" height="520"></canvas>
        <div class="text" id="m2Text"></div>
        <div class="hint">Duas posições fechadas. Uma fenda: agir no verbo para deslizar o sentido.</div>
      </div>
    </article>

    <article class="card" id="cardM3">
      <div class="head">
        <div class="t">
          <b>Móbile 3 — Foco / intensificação</b>
          <small>7 fragmentos · clique em palavras e fragmentos para reforçar um traço predominante</small>
        </div>
        <div class="mini">
          <button id="m3Share">Partilhar</button>
        </div>
      </div>
      <div class="stage">
        <canvas id="m3Canvas" width="980" height="520"></canvas>
        <div class="text" id="m3Text"></div>
        <div class="hint">O que você insiste em clicar vira estilo: o mundo começa a obedecer ao teu foco.</div>
      </div>
    </article>

    <article class="card" id="cardM4">
      <div class="head">
        <div class="t">
          <b>Móbile 4 — Fonografia (plosivas / fricativas)</b>
          <small>5 fragmentos · clique num regime: isso inclina som, cortes e continuidade</small>
        </div>
        <div class="mini">
          <button id="m4Share">Partilhar</button>
        </div>
      </div>
      <div class="stage">
        <div class="chips" id="m4Chips"></div>
        <canvas id="m4Canvas" width="980" height="520"></canvas>
        <div class="text" id="m4Text"></div>
        <div class="hint">Aqui a palavra vira corpo: seco/massa/arranho — e isso volta pro visual.</div>
      </div>
    </article>

    <article class="card final" id="cardFinal">
      <div class="head">
        <div class="t">
          <b>Estado alcançado — tua exposição provisória</b>
          <small>10 fragmentos · gera texto (estilo curatorial + crítica), pronto pra partilhar</small>
        </div>
        <div class="mini">
          <button id="btnFinalize">Gerar a minha expo</button>
          <button id="finalShare">Partilhar estado</button>
        </div>
      </div>
      <div class="stage">
        <div>
          <canvas id="finalCanvas" width="980" height="620"></canvas>
          <div class="text" id="finalText"></div>
          <div class="hint">Cessar aqui não é “fim”: é um recorte que deixa resto — e o resto chama reencenação.</div>
        </div>
        <div class="side">
          <div class="kpi">
            <div class="box"><b>Posição</b><span id="kFront">—</span></div>
            <div class="box"><b>Densidade</b><span id="kDense">—</span></div>
            <div class="box"><b>Continuidade</b><span id="kCont">—</span></div>
            <div class="box"><b>Regime fonográfico</b><span id="kPh">—</span></div>
          </div>
          <div class="box">
            <b>Assinatura</b>
            <span>suiornotsui</span>
          </div>
        </div>
      </div>
    </article>

  </section>
</main>

<footer>
  MÓBILES · entrada — máquina curatorial-semântica (front-end) · suiornotsui
</footer>

<dialog id="shareDlg">
  <div class="dlgHead">
    <b id="shareTitle">Partilhar</b>
    <div style="font-size:12px;color:var(--muted);margin-top:4px" id="shareNote"></div>
  </div>
  <div class="dlgBody">
    <canvas id="shareCanvas" width="1200" height="1200" style="width:100%;height:auto;border-radius:14px;border:1px solid var(--line);background:#fff"></canvas>
    <div style="height:10px"></div>
    <pre id="shareText"></pre>
  </div>
  <div class="dlgBtns">
    <button class="btn" id="copyText">Copiar texto</button>
    <button class="btn" id="downloadImg">Baixar imagem</button>
    <button class="btn" id="nativeShare">Partilhar (nativo)</button>
    <button class="btn" id="closeDlg">Fechar</button>
  </div>
</dialog>

<script>
/* =======================================================
   0) Base URL robusta (GitHub Pages)
======================================================= */
function getBaseMobilesURL(){
  const u = new URL(window.location.href);
  const idx = u.pathname.indexOf("/mobiles/");
  if(idx >= 0){
    const basePath = u.pathname.slice(0, idx + "/mobiles/".length);
    return new URL(basePath, u.origin).toString();
  }
  return new URL("./", window.location.href).toString();
}
const BASE_MOBILES = getBaseMobilesURL();

/* =======================================================
   1) Utilitários
======================================================= */
function clamp(x,min,max){ return Math.max(min, Math.min(max, x)); }
function lerp(a,b,t){ return a + (b-a)*t; }
function rnd(a,b){ return a + Math.random()*(b-a); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function nowISO(){ return new Date().toISOString().slice(0,19).replace("T"," "); }
function signLabel(v, neg, pos){ return v< -0.2 ? neg : (v>0.2?pos:"entre"); }

/* =======================================================
   2) Léxico COMPLETO (70 operadores × 3 realizações)
   - variante: "surda" | "sonora" | "fricativa"
======================================================= */
const LEX = {
  nouns: [
    {k:"vestigio", surda:"traço", sonora:"marca", fricativa:"sombra"},
    {k:"sopro", surda:"pingo", sonora:"bafo", fricativa:"suspiro"},
    {k:"dobra", surda:"prega", sonora:"curva", fricativa:"flexão"},
    {k:"canto", surda:"quina", sonora:"beira", fricativa:"franja"},
    {k:"margem", surda:"limite", sonora:"borda", fricativa:"fronteira"},
    {k:"poeira", surda:"pó", sonora:"bruma", fricativa:"cinza"},
    {k:"silencio", surda:"pausa", sonora:"calma", fricativa:"sussurro"},
    {k:"rastro", surda:"pegada", sonora:"vesta", fricativa:"resíduo"},
    {k:"fragmento", surda:"cortezinho", sonora:"bordado", fricativa:"desfiado"},
    {k:"detalhe", surda:"ponto", sonora:"miolo", fricativa:"nuança"},
    {k:"lembranca", surda:"nota", sonora:"memória", fricativa:"recordação"},
    {k:"demora", surda:"pausa", sonora:"espera", fricativa:"suspensão"},
    {k:"intervalo", surda:"corte", sonora:"entre", fricativa:"fresta"},
    {k:"eco", surda:"toque", sonora:"resposta", fricativa:"ressonância"},
    {k:"resto", surda:"ruga", sonora:"sobra", fricativa:"resíduo"},
    {k:"plano", surda:"linha", sonora:"base", fricativa:"superfície"},
    {k:"camada", surda:"capa", sonora:"nível", fricativa:"espessura"},
    {k:"textura", surda:"trama", sonora:"tecido", fricativa:"fibra"},
    {k:"superficie", surda:"pele", sonora:"face", fricativa:"película"},
    {k:"escala", surda:"passo", sonora:"medida", fricativa:"proporção"},
    {k:"ritmo", surda:"pulso", sonora:"cadência", fricativa:"fluência"},
    {k:"materia", surda:"corpo", sonora:"substância", fricativa:"massa"},
    {k:"presenca", surda:"toque", sonora:"vulto", fricativa:"sombra"},
    {k:"tensao", surda:"nó", sonora:"peso", fricativa:"pressão"},
    {k:"campo", surda:"plano", sonora:"território", fricativa:"ambiente"},
    {k:"emergencia", surda:"salto", sonora:"aparição", fricativa:"insurgência"},
    {k:"configuracao", surda:"forma", sonora:"estrutura", fricativa:"composição"},
    {k:"cessacao", surda:"corte", sonora:"encerramento", fricativa:"silenciamento"},
  ],
  verbs: [
    {k:"aproximar", surda:"chegar", sonora:"beirar", fricativa:"esfumar"},
    {k:"reparar", surda:"notar", sonora:"observar", fricativa:"esmiuçar"},
    {k:"tocar", surda:"tatear", sonora:"roçar", fricativa:"aflorar"},
    {k:"escutar", surda:"ouvir", sonora:"acolher", fricativa:"sintonizar"},
    {k:"demorar", surda:"parar", sonora:"permanecer", fricativa:"alongar-se"},
    {k:"pousar", surda:"cair", sonora:"assentar", fricativa:"deslizar"},
    {k:"acompanhar", surda:"seguir", sonora:"amparar", fricativa:"entrelaçar"},
    {k:"cuidar", surda:"zelar", sonora:"nutrir", fricativa:"suavizar"},
    {k:"recortar", surda:"cortar", sonora:"delimitar", fricativa:"fissurar"},
    {k:"deslocar", surda:"mover", sonora:"transferir", fricativa:"deslizar"},
    {k:"sustentar", surda:"segurar", sonora:"manter", fricativa:"suspender"},
    {k:"distribuir", surda:"partir", sonora:"organizar", fricativa:"espalhar"},
    {k:"sobrepor", surda:"cobrir", sonora:"acumular", fricativa:"sobrefluir"},
    {k:"atravessar", surda:"passar", sonora:"cruzar", fricativa:"permeiar"},
    {k:"insinuar", surda:"sugerir", sonora:"indicar", fricativa:"sussurrar"},
    {k:"insistir", surda:"bater", sonora:"persistir", fricativa:"ressoar"},
    {k:"interromper", surda:"cortar", sonora:"cessar", fricativa:"esvair-se"},
    {k:"fixar", surda:"marcar", sonora:"estabelecer", fricativa:"sedimentar"},
    {k:"suspender", surda:"parar", sonora:"reter", fricativa:"flutuar"},
    {k:"reter", surda:"prender", sonora:"guardar", fricativa:"conservar"},
    {k:"abandonar", surda:"largar", sonora:"deixar", fricativa:"dissolver"},
    {k:"transformar", surda:"romper", sonora:"converter", fricativa:"transfigurar"},
  ],
  adjs: [
    {k:"leve", surda:"claro", sonora:"brando", fricativa:"suave"},
    {k:"minimo", surda:"curto", sonora:"pequeno", fricativa:"sutil"},
    {k:"fragil", surda:"ténue", sonora:"delicado", fricativa:"sensível"},
    {k:"tenue", surda:"fino", sonora:"delgado", fricativa:"esfumado"},
    {k:"quase", surda:"breve", sonora:"próximo", fricativa:"difuso"},
    {k:"opaco", surda:"denso", sonora:"turvo", fricativa:"fosco"},
    {k:"poroso", surda:"aberto", sonora:"vazado", fricativa:"permeável"},
    {k:"irregular", surda:"torto", sonora:"oscilante", fricativa:"assimétrico"},
    {k:"difuso", surda:"solto", sonora:"amplo", fricativa:"disperso"},
    {k:"latente", surda:"oculto", sonora:"presente", fricativa:"subjacente"},
    {k:"instavel", surda:"quebrado", sonora:"oscilante", fricativa:"flutuante"},
    {k:"provisorio", surda:"breve", sonora:"mutável", fricativa:"transitório"},
  ],
  advs: [
    {k:"ainda", surda:"já", sonora:"agora", fricativa:"sempre"},
    {k:"quase", surda:"logo", sonora:"perto", fricativa:"talvez"},
    {k:"lentamente", surda:"aos poucos", sonora:"com calma", fricativa:"suavemente"},
    {k:"por_vezes", surda:"às vezes", sonora:"frequentemente", fricativa:"ocasionalmente"},
    {k:"sempre", surda:"toda vez", sonora:"continuamente", fricativa:"infinitamente"},
    {k:"raramente", surda:"quase nunca", sonora:"poucas vezes", fricativa:"esporadicamente"},
    {k:"talvez", surda:"quem sabe", sonora:"possivelmente", fricativa:"eventualmente"},
    {k:"agora", surda:"já", sonora:"neste momento", fricativa:"presentemente"},
  ]
};

function realize(entry, variant){
  return entry[variant] || entry.sonora || entry.surda || entry.fricativa;
}

/* =======================================================
   3) Fonografia (sem áudio) → variante lexical
======================================================= */
const PHONO = { mode:"neutro", vector:{dry:0, voiced:0, open:0} };
const PHONO_PRESETS = [
  {key:"plosiva_surda",  label:"p/t/k (seco)",    vec:{dry:+0.8, voiced:-0.6, open:0}},
  {key:"plosiva_sonora", label:"b/d/g (massa)",   vec:{dry:+0.4, voiced:+0.8, open:0}},
  {key:"fricativa_surda",label:"f/s/x (arranho)", vec:{dry:+0.2, voiced:-0.4, open:+0.2}},
  {key:"fricativa_sonora",label:"v/z/j (desgaste)",vec:{dry:-0.1, voiced:+0.3, open:+0.3}},
  {key:"aberto",         label:"vogais abertas",  vec:{dry:-0.2, voiced:+0.1, open:+0.9}},
  {key:"fechado",        label:"vogais fechadas", vec:{dry:+0.2, voiced:+0.1, open:-0.9}},
];

function currentVariant(){
  // regra simples e sensível:
  // - dry alto puxa "surda" (corte seco)
  // - voiced alto puxa "sonora" (massa)
  // - open alto puxa "fricativa" (passagem/aresta)
  const d = PHONO.vector.dry, v = PHONO.vector.voiced, o = PHONO.vector.open;
  const ad = Math.abs(d), av = Math.abs(v), ao = Math.abs(o);
  if(ad >= av && ad >= ao) return "surda";
  if(av >= ad && av >= ao) return "sonora";
  return "fricativa";
}

/* =======================================================
   4) Estado (campo) + espraiamento
======================================================= */
const Global = {
  front:0, dense:0, cont:0,
  pressure:0,
};
const Mobiles = {
  m1:{local:{front:0,dense:0,cont:0}, clicks:0, config:null},
  m2:{local:{front:0,dense:0,cont:0}, clicks:0, config:null, flip:false},
  m3:{local:{front:0,dense:0,cont:0}, clicks:0, config:null},
  m4:{local:{front:0,dense:0,cont:0}, clicks:0, config:null},
  final:{local:{front:0,dense:0,cont:0}, clicks:0, config:null},
};
const SPREAD = {
  m1:{m1:1.0,m2:0.62,m3:0.36,m4:0.18},
  m2:{m2:1.0,m1:0.50,m3:0.40,m4:0.20},
  m3:{m3:1.0,m2:0.55,m4:0.40,m1:0.20},
  m4:{m4:1.0,m3:0.62,m2:0.30,m1:0.18},
};

function resetAll(){
  Global.front=0; Global.dense=0; Global.cont=0; Global.pressure=0;
  PHONO.mode="neutro"; PHONO.vector={dry:0, voiced:0, open:0};
  for(const k of ["m1","m2","m3","m4","final"]){
    Mobiles[k].local={front:0,dense:0,cont:0};
    Mobiles[k].clicks=0;
    Mobiles[k].config=null;
  }
  Mobiles.m2.flip=false;
  updatePill();
}

function applyDelta(fromKey, d){
  const spread = SPREAD[fromKey] || {[fromKey]:1.0};
  for(const k in spread){
    const s = spread[k];
    Mobiles[k].local.front = clamp(Mobiles[k].local.front + (d.front||0)*s, -1, 1);
    Mobiles[k].local.dense = clamp(Mobiles[k].local.dense + (d.dense||0)*s, -1, 1);
    Mobiles[k].local.cont  = clamp(Mobiles[k].local.cont  + (d.cont ||0)*s, -1, 1);
  }
  Global.front = clamp(Global.front + (d.front||0)*0.12, -1, 1);
  Global.dense = clamp(Global.dense + (d.dense||0)*0.12, -1, 1);
  Global.cont  = clamp(Global.cont  + (d.cont ||0)*0.12, -1, 1);
  Global.pressure = clamp(Global.pressure + (d.pressure||0)*0.08, 0, 3);
  updatePill();
}

function combinedState(mKey){
  const L = Mobiles[mKey].local;
  return {
    front: clamp(L.front + Global.front*0.25, -1, 1),
    dense: clamp(L.dense + Global.dense*0.25, -1, 1),
    cont:  clamp(L.cont  + Global.cont *0.25, -1, 1),
  };
}

function updatePill(){
  const s = combinedState("m1");
  const pill = document.getElementById("pillState");
  pill.textContent = `campo: ${signLabel(s.front,"fundo","frente")} · ${signLabel(s.dense,"rarefeito","denso")} · ${signLabel(s.cont,"corte","contínuo")}`;
}

/* =======================================================
   5) Campo visual (slots 120) + Sui override (sui.json)
   - mantém slot 53 como assets/sui/slot_053.jpg (via JSON)
======================================================= */
let SUI_MAP = null;

function slotId(i){ return `slot_${String(i).padStart(3,"0")}`; }

const FAMS = [
  {id:"F1", name:"continuidade linear", axes:{front:-0.2,dense:-0.1,cont:+0.8}},
  {id:"F2", name:"corte vertical",      axes:{front:+0.3,dense:+0.2,cont:-0.8}},
  {id:"F3", name:"deslocamento oblíquo",axes:{front:+0.5,dense:-0.1,cont:+0.2}},
  {id:"F4", name:"ritmo repetitivo",    axes:{front:0.0,dense:+0.2,cont:+0.6}},
  {id:"F5", name:"ruptura",             axes:{front:+0.2,dense:+0.3,cont:-0.9}},
  {id:"F6", name:"densidade",           axes:{front:+0.1,dense:+0.9,cont:-0.2}},
  {id:"F7", name:"rarefação",           axes:{front:-0.3,dense:-0.9,cont:+0.4}},
  {id:"F8", name:"centro instável",     axes:{front:+0.2,dense:+0.5,cont:+0.1}},
  {id:"F9", name:"campo homogêneo",     axes:{front:+0.1,dense:-0.2,cont:-0.5}},
  {id:"F10",name:"direção múltipla",    axes:{front:+0.4,dense:-0.2,cont:-0.6}},
  {id:"F11",name:"contorno",            axes:{front:-0.1,dense:+0.6,cont:+0.2}},
  {id:"F12",name:"massa",               axes:{front:-0.1,dense:+0.8,cont:-0.4}},
];

const FIELD = { slots:[] };

function buildField(){
  FIELD.slots = [];
  for(let i=1;i<=120;i++){
    const fam = FAMS[(i-1)%12];
    const v = Math.floor((i-1)/12) % 10;
    const t = (v-4.5)/4.5;
    const axes = {
      front: clamp(fam.axes.front + 0.18*t + rnd(-0.03,0.03), -1, 1),
      dense: clamp(fam.axes.dense + 0.22*t + rnd(-0.03,0.03), -1, 1),
      cont:  clamp(fam.axes.cont  - 0.20*t + rnd(-0.03,0.03), -1, 1),
    };
    FIELD.slots.push({ id: slotId(i), idx:i, fam:fam.id, famName:fam.name, v, axes, sui:null });
  }
}

async function tryLoadSui(){
  try{
    const url = new URL("sui.json", BASE_MOBILES + "entrada/");
    // se tua entrada estiver em /mobiles/entrada/, isso bate certo.
    const res = await fetch(url.toString() + "?cache=" + Date.now());
    if(!res.ok) throw new Error("no sui.json");
    const data = await res.json();
    SUI_MAP = data;

    for(const s of FIELD.slots){
      const key = String(s.idx); // "53"
      if(SUI_MAP && SUI_MAP[key]){
        const rel = SUI_MAP[key]; // "assets/sui/slot_053.jpg"
        s.sui = { path: (BASE_MOBILES + rel.replace(/^\.?\/*/, "")) };
      }
    }
  }catch(e){
    SUI_MAP = null;
  }
}

function slotScore(slot, state){
  const dx =
    Math.abs(slot.axes.front - state.front) * 0.9 +
    Math.abs(slot.axes.dense - state.dense) * 0.7 +
    Math.abs(slot.axes.cont  - state.cont ) * 1.0;

  let score = -(dx) + rnd(-0.05,0.05);

  // tendência para Sui aparecer mais (mas não sempre)
  if(slot.sui) score += 1.80;

  return score;
}

function sampleSlots(n, state){
  const pool = FIELD.slots.slice();
  pool.sort((a,b)=> slotScore(b,state) - slotScore(a,state));
  const K = Math.min(36, pool.length);
  const top = pool.slice(0,K);
  // shuffle leve
  for(let i=top.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [top[i],top[j]] = [top[j],top[i]];
  }
  const picked = top.slice(0,n);

  const hasAnySui = FIELD.slots.some(s=>s.sui);
  const hasSuiInPicked = picked.some(s=>s.sui);

  // garantia suave: 90% de puxar 1 Sui se nenhum veio
  if(hasAnySui && !hasSuiInPicked && Math.random() < 0.90){
    const suiCandidates = pool.filter(s=>s.sui).slice(0, 12);
    if(suiCandidates.length){
      picked[picked.length-1] = pick(suiCandidates);
    }
  }
  return picked;
}

/* =======================================================
   6) Desenho: fragmentos NÃO-Sui com gramática (12 famílias)
======================================================= */
function clearCanvas(c){
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle = "rgba(255,255,255,0.35)";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle="rgba(0,0,0,0.05)";
  for(let i=0;i<240;i++) ctx.fillRect(rnd(0,c.width), rnd(0,c.height), 1, 1);
}

function line(ctx,x1,y1,x2,y2,col,w){
  ctx.strokeStyle=col; ctx.lineWidth=w; ctx.beginPath();
  ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
}

function drawFamily(ctx, fam, v, x,y,w,h){
  const ink="rgba(0,0,0,0.22)";
  const cold="rgba(35,55,85,0.18)";
  const k = 1 + Math.floor(v/2);

  ctx.save();
  ctx.translate(x,y);

  if(fam==="F1"){
    for(let i=0;i<2+k;i++){
      const yy = (i+1)*(h/(3+k)) + rnd(-2,2);
      line(ctx, 10,yy, w-10,yy, cold, 1.2);
    }
  } else if(fam==="F2"){
    for(let i=0;i<2+k;i++){
      const xx = (i+1)*(w/(3+k)) + rnd(-2,2);
      line(ctx, xx,10, xx,h-10, ink, 1.5);
    }
  } else if(fam==="F3"){
    for(let i=0;i<3+k;i++){
      const x1 = rnd(10,w-10), y1=rnd(10,h-10);
      line(ctx, x1,y1, x1+rnd(-60,60), y1+rnd(-60,60), cold, 1.2);
    }
  } else if(fam==="F4"){
    ctx.fillStyle="rgba(0,0,0,0.16)";
    const dots = 70 + v*12;
    for(let i=0;i<dots;i++) ctx.fillRect(rnd(6,w-6), rnd(6,h-6), 1, 1);
  } else if(fam==="F5"){
    ctx.strokeStyle="rgba(0,0,0,0.18)";
    ctx.lineWidth=1.2;
    const n = 2 + Math.floor(v/4);
    for(let i=0;i<n;i++){
      const rw = w*(0.34 + i*0.13);
      const rh = h*(0.34 + i*0.11);
      ctx.strokeRect((w-rw)/2 + rnd(-2.5,2.5), (h-rh)/2 + rnd(-2.5,2.5), rw, rh);
    }
  } else if(fam==="F6"){
    const n = 2 + Math.floor(v/3);
    for(let i=0;i<n;i++){
      const rw = w*(0.34 + rnd(0,0.28));
      const rh = h*(0.34 + rnd(0,0.28));
      ctx.fillStyle="rgba(0,0,0,"+(0.18+rnd(0,0.18))+")";
      ctx.fillRect(rnd(0,w-rw), rnd(0,h-rh), rw, rh);
    }
  } else if(fam==="F7"){
    for(let i=0;i<k*3;i++){
      const yy = (i*(h/(k*3))) + rnd(-1,1);
      line(ctx, 8,yy, w-8,yy, cold, 1.0);
    }
  } else if(fam==="F8"){
    ctx.fillStyle="rgba(0,0,0,0.08)";
    const rw = w*(0.48 + rnd(-0.1,0.1));
    const rh = h*(0.30 + rnd(-0.08,0.08));
    ctx.fillRect(rnd(0,w-rw), rnd(0,h-rh), rw, rh);
    line(ctx, 10,h*0.72, w-10,h*0.30, cold, 1.2);
  } else if(fam==="F9"){
    for(let i=0;i<10+v;i++){
      const px=rnd(10,w-10), py=rnd(10,h-10);
      line(ctx, px-10,py, px+10,py, ink, 1.2);
    }
  } else if(fam==="F10"){
    for(let i=0;i<3+Math.floor(v/2);i++){
      const px1=rnd(10,w-10), py1=rnd(10,h-10);
      line(ctx, px1,py1, px1+rnd(-40,40), py1+rnd(-40,40), cold, 1.0);
    }
  } else if(fam==="F11"){
    const n = 3 + Math.floor(v/3);
    for(let i=0;i<n;i++){
      ctx.fillStyle="rgba(55,75,95,"+(0.10+rnd(0,0.10))+")";
      const rw = w*(0.30+rnd(0,0.35));
      const rh = h*(0.20+rnd(0,0.35));
      ctx.fillRect(rnd(0,w-rw), rnd(0,h-rh), rw, rh);
    }
  } else if(fam==="F12"){
    ctx.strokeStyle="rgba(0,0,0,0.10)";
    ctx.strokeRect(8,8,w-16,h-16);
    if(v>6) line(ctx, 12,h-14, w-12,h-14, "rgba(0,0,0,0.10)", 1);
  }

  ctx.strokeStyle="rgba(0,0,0,0.10)";
  ctx.lineWidth=1;
  ctx.strokeRect(0.5,0.5,w-1,h-1);
  ctx.restore();
}

const ImageCache = new Map();
function loadImg(src){
  if(ImageCache.has(src)) return ImageCache.get(src);
  const img = new Image();
  img.decoding="async";
  img.loading="lazy";
  img.src = src;
  ImageCache.set(src,img);
  return img;
}

function drawFragment(ctx, slot, x,y,w,h, alpha){
  ctx.save();
  ctx.globalAlpha = alpha;

  // Sui override: desenha imagem
  if(slot.sui){
    const img = loadImg(slot.sui.path);
    ctx.fillStyle="rgba(255,255,255,0.62)";
    ctx.fillRect(x,y,w,h);
    if(img.complete && img.naturalWidth){
      const r = Math.min(w/img.naturalWidth, h/img.naturalHeight);
      const dw = img.naturalWidth*r;
      const dh = img.naturalHeight*r;
      ctx.drawImage(img, x+(w-dw)/2, y+(h-dh)/2, dw, dh);
    }else{
      ctx.fillStyle="rgba(0,0,0,0.08)";
      ctx.fillRect(x+12,y+12,w-24,h-24);
    }
    ctx.strokeStyle="rgba(0,0,0,0.12)";
    ctx.strokeRect(x+0.5,y+0.5,w-1,h-1);
    ctx.restore();
    return;
  }

  // NÃO-Sui: gramática por família
  ctx.fillStyle="rgba(255,255,255,0.48)";
  ctx.fillRect(x,y,w,h);
  drawFamily(ctx, slot.fam, slot.v, x,y,w,h);
  ctx.restore();
}

/* =======================================================
   7) Layout por móbile (paisagens mínimas)
   - m1: móbile de berço
   - m2: montanhas + bichinhos mínimos
   - m3: labirinto
   - m4: escadas (Escher leve)
======================================================= */
function drawScene(ctx, key, W,H){
  ctx.save();
  ctx.fillStyle="rgba(255,255,255,0.12)";
  ctx.fillRect(0,0,W,H);

  const ink="rgba(0,0,0,0.12)";
  const cold="rgba(35,55,85,0.10)";

  if(key==="m1"){
    // arco do móbile
    ctx.strokeStyle=ink; ctx.lineWidth=2;
    ctx.beginPath();
    ctx.arc(W/2, 70, 150, Math.PI, 2*Math.PI);
    ctx.stroke();
    // haste
    ctx.beginPath(); ctx.moveTo(W/2, 70); ctx.lineTo(W/2, 20); ctx.stroke();
  }
  if(key==="m2"){
    // montanhas
    ctx.strokeStyle=cold; ctx.lineWidth=2;
    for(let i=0;i<3;i++){
      const x = 120 + i*260;
      ctx.beginPath();
      ctx.moveTo(x, H-120);
      ctx.lineTo(x+140, H-320 + rnd(-18,18));
      ctx.lineTo(x+280, H-120);
      ctx.stroke();
    }
    // bichinhos mínimos (pastando)
    ctx.strokeStyle="rgba(0,0,0,0.14)";
    for(let i=0;i<5;i++){
      const bx = 140 + i*150 + rnd(-10,10);
      const by = H-140 + rnd(-6,6);
      ctx.beginPath();
      ctx.moveTo(bx,by);
      ctx.lineTo(bx+18,by);
      ctx.lineTo(bx+22,by-8);
      ctx.stroke();
    }
  }
  if(key==="m3"){
    // labirinto
    ctx.strokeStyle="rgba(0,0,0,0.10)";
    ctx.lineWidth=1.6;
    const step=48;
    for(let y=90;y<H-60;y+=step){
      for(let x=70;x<W-70;x+=step){
        if(Math.random()<0.35){
          ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+step,y); ctx.stroke();
        }
        if(Math.random()<0.35){
          ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x,y+step); ctx.stroke();
        }
      }
    }
  }
  if(key==="m4"){
    // escadas leves
    ctx.strokeStyle="rgba(0,0,0,0.10)";
    ctx.lineWidth=1.6;
    for(let i=0;i<7;i++){
      const x = 90 + i*120 + rnd(-12,12);
      const y = 110 + rnd(-8,8);
      const w = 80, h = 220;
      ctx.strokeRect(x,y,w,h);
      for(let s=0;s<7;s++){
        const yy = y + (s+1)*(h/8);
        ctx.beginPath(); ctx.moveTo(x,yy); ctx.lineTo(x+w,yy); ctx.stroke();
      }
      // “quebra” escher
      ctx.beginPath(); ctx.moveTo(x+w, y+h*0.5); ctx.lineTo(x+w+60, y+h*0.35); ctx.stroke();
    }
  }

  ctx.restore();
}

function layoutMobile(ctx, cfg, key){
  const c = ctx.canvas;
  clearCanvas(c);
  drawScene(ctx, key, c.width, c.height);

  const pad = 40;
  const frs = cfg.fragments;
  const scene = (key==="m1") ? "móbile" : "campo";
  const boxes = [];

  for(let i=0;i<frs.length;i++){
    const z = i/(frs.length-1 || 1); // 0..1
    const slot = frs[i];

    const w = lerp(210, 340, z) * (key==="final"?0.88:1);
    const h = lerp(150, 250, z) * (key==="final"?0.90:1);

    let bandX = lerp(pad, c.width-pad, (i+1)/(frs.length+1));
    let x = bandX + rnd(-60,60) - w/2;
    let y = lerp(c.height*0.22, c.height*0.78, z) + rnd(-18,18) - h/2;

    if(scene==="móbile"){
      y = lerp(160, c.height-120, z) + rnd(-28,28) - h/2;
      // fio
      ctx.save();
      ctx.strokeStyle="rgba(0,0,0,0.18)";
      ctx.lineWidth=1.3;
      ctx.beginPath();
      ctx.moveTo(bandX, 88);
      ctx.lineTo(x + w/2, y);
      ctx.stroke();
      ctx.restore();
    }

    const a = lerp(0.62, 1.0, z);
    drawFragment(ctx, slot, x,y,w,h, a);
    boxes.push({slot, x,y,w,h, z});
  }
  cfg._boxes = boxes;
}

function hitTest(cfg, x,y){
  const boxes = cfg._boxes || [];
  // prioriza topo (z maior)
  for(let i=boxes.length-1;i>=0;i--){
    const b = boxes[i];
    if(x>=b.x && x<=b.x+b.w && y>=b.y && y<=b.y+b.h) return b;
  }
  return null;
}

/* =======================================================
   8) Texto: moldes “curatoriais”, sempre gramaticais
======================================================= */
function pickByState(arr, s, axis){
  // escolhe índice enviesado por eixo (-1..1)
  const t = (axis==="front") ? s.front : (axis==="dense"?s.dense:s.cont);
  const bias = clamp((t+1)/2, 0, 1);
  const idx = Math.floor(bias*(arr.length-1) + rnd(-0.7,0.7));
  return arr[clamp(idx,0,arr.length-1)];
}

function curatorialLines(mKey, s, variant){
  const N = (a)=> realize(pick(a), variant);
  const n1 = realize(pickByState(LEX.nouns, s, "front"), variant);
  const n2 = realize(pickByState(LEX.nouns, s, "cont"), variant);
  const n3 = realize(pickByState(LEX.nouns, s, "dense"), variant);

  const v1 = realize(pickByState(LEX.verbs, s, "cont"), variant);
  const v2 = realize(pickByState(LEX.verbs, s, "front"), variant);

  const a1 = realize(pickByState(LEX.adjs, s, "dense"), variant);
  const a2 = realize(pickByState(LEX.adjs, s, "cont"), variant);

  const adv1 = realize(pickByState(LEX.advs, s, "cont"), variant);
  const adv2 = realize(pickByState(LEX.advs, s, "front"), variant);

  // conectivos fixos (para “voz”)
  const C = {
    onde: pick(["onde","quando","enquanto"]),
    como: pick(["como","quase como","como se"]),
    por:  pick(["por isso","por fim","por vezes"]),
  };

  if(mKey==="m1"){
    return [
      ["Aqui", "nasce", "um", n1, a1 + ",", C.como, "um", n2, "que", adv1, "insiste."],
      ["O", n3, "não", "explica:", "ele", "pede", "que", "você", v1, "o", n2 + "."],
      ["E", C.por + ",", "o", "resto", "fica", "de", "fora", "—", "para", "voltar", adv2 + "."],
    ];
  }

  if(mKey==="m2"){
    // sintaxe: sujeito/objeto
    const subj = Mobiles.m2.flip ? n2 : n1;
    const obj  = Mobiles.m2.flip ? n1 : n2;
    return [
      ["O", subj, "toma", "a", "frente;", "o", obj, "fica", "em", "fundo."],
      ["Se", "você", "só", "inverte,", "repete", "a", "mesma", "lei."],
      ["A", "fuga", "é", "agir:", "é", "preciso", v2, "o", obj, adv1 + "."],
    ];
  }

  if(mKey==="m3"){
    return [
      ["Você", "repara", "no", n1, "e", "o", n1, "cresce."],
      ["Clique", "vira", "foco:", "o", a2, "ganha", "peso", "no", n3 + "."],
      ["Assim", "o", "mundo", "aprende", "a", "te", v1, adv2 + "."],
    ];
  }

  if(mKey==="m4"){
    return [
      ["Som", "vira", "corte:", "um", n2, a2, "pede", "outro", "ritmo."],
      ["Se", "você", "reforça", "aresta,", "a", "imagem", "fica", adv1 + "."],
      ["Se", "você", "abre", "passagem,", "o", n1, "começa", "a", v2, adv2 + "."],
    ];
  }

  // final
  return [
    ["A", "tua", "curadoria", "fixa", "um", n1, a1, "como", "eixo."],
    ["O", "estilo", "prefere", n3, "e", "evita", n2, "—", "e", "isso", "aparece."],
    ["Partilha", "e", "reencena:", "alguém", "vai", "achar", "o", "fragmento", "que", "te", "faltou."],
  ];
}

function renderText(container, lines, onWord){
  container.innerHTML = "";
  for(const words of lines){
    const div = document.createElement("div");
    div.className = "line";
    for(const w of words){
      const span = document.createElement("span");
      span.className = "word";
      span.textContent = w;
      span.addEventListener("click", ()=> onWord(w));
      div.appendChild(span);
      div.appendChild(document.createTextNode(" "));
    }
    container.appendChild(div);
  }
}

/* =======================================================
   9) Config de cada móbile
======================================================= */
function buildConfig(mKey){
  const s = combinedState(mKey);
  let n = 3;
  if(mKey==="m2") n = 2;
  if(mKey==="m3") n = 7;
  if(mKey==="m4") n = 5;
  if(mKey==="final") n = 10;

  const fragments = sampleSlots(n, s);
  const variant = currentVariant();
  const lines = curatorialLines(mKey, s, variant);

  return { state:s, fragments, variant, lines, _boxes:[] };
}

function deltaFromSlotClick(slot){
  // clique em fragmento intensifica eixos do slot
  return {
    front: 0.22 * slot.axes.front,
    dense: 0.22 * slot.axes.dense,
    cont:  0.22 * slot.axes.cont,
    pressure: 0.12,
  };
}

function deltaFromWordClick(word){
  // simples: “palavras” puxam traços por heurística
  const w = (word||"").toLowerCase();
  const d = {front:0, dense:0, cont:0, pressure:0.08};

  if(w.includes("corte") || w.includes("quebra") || w.includes("nó") || w.includes("peso")){
    d.cont -= 0.22; d.dense += 0.10;
  }
  if(w.includes("suave") || w.includes("sutil") || w.includes("esfum") || w.includes("sus")){
    d.cont += 0.18; d.front -= 0.08;
  }
  if(w.includes("frente") || w.includes("vulto") || w.includes("apari")){
    d.front += 0.18;
  }
  if(w.includes("campo") || w.includes("massa") || w.includes("subst")){
    d.dense += 0.18;
  }
  return d;
}

/* =======================================================
   10) Render e interação
======================================================= */
function renderMobile(mKey, canvasId, textId){
  const c = document.getElementById(canvasId);
  const ctx = c.getContext("2d");

  const cfg = buildConfig(mKey);
  Mobiles[mKey].config = cfg;

  layoutMobile(ctx, cfg, mKey);

  const t = document.getElementById(textId);
  renderText(t, cfg.lines, (w)=>{
    applyDelta(mKey, deltaFromWordClick(w));
    rerenderAll();
  });

  c.onclick = (ev)=>{
    const r = c.getBoundingClientRect();
    const x = (ev.clientX - r.left) * (c.width / r.width);
    const y = (ev.clientY - r.top)  * (c.height/ r.height);
    const hit = hitTest(cfg, x,y);
    if(hit){
      applyDelta(mKey, deltaFromSlotClick(hit.slot));
      Mobiles[mKey].clicks++;
      rerenderAll();
    }
  };
}

function renderFinal(){
  const c = document.getElementById("finalCanvas");
  const ctx = c.getContext("2d");
  const cfg = buildConfig("final");
  Mobiles.final.config = cfg;
  layoutMobile(ctx, cfg, "final");

  const t = document.getElementById("finalText");
  renderText(t, cfg.lines, (w)=>{
    applyDelta("m3", deltaFromWordClick(w));
    rerenderAll();
  });

  const s = cfg.state;
  document.getElementById("kFront").textContent = signLabel(s.front,"fundo","frente");
  document.getElementById("kDense").textContent = signLabel(s.dense,"rarefeito","denso");
  document.getElementById("kCont").textContent  = signLabel(s.cont,"corte","contínuo");
  document.getElementById("kPh").textContent    = currentVariant();
}

function rerenderAll(){
  renderMobile("m1","m1Canvas","m1Text");
  renderMobile("m2","m2Canvas","m2Text");
  renderMobile("m3","m3Canvas","m3Text");
  renderMobile("m4","m4Canvas","m4Text");
  if(Mobiles.final.config) renderFinal();
}

/* =======================================================
   11) Share (imagem + texto) — com fallback
======================================================= */
function configToText(cfg){
  const a = (cfg.lines?.[0]||[]).join(" ");
  const b = (cfg.lines?.[1]||[]).join(" ");
  const c = (cfg.lines?.[2]||[]).join(" ");
  return [a,b,c].filter(Boolean).join("\n");
}
function exportCompositePNG(srcCanvas, cfg){
  const out = document.getElementById("shareCanvas");
  const ctx = out.getContext("2d");
  const W=out.width, H=out.height;

  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--bg").trim() || "#f4f2ee";
  ctx.fillRect(0,0,W,H);

  // imagem
  const pad=80;
  const targetW=W-pad*2;
  const ratio = srcCanvas.height/srcCanvas.width;
  const targetH=Math.min(H*0.62, targetW*ratio);
  const dx=(W-targetW)/2;
  const dy=90;
  ctx.drawImage(srcCanvas, dx, dy, targetW, targetH);

  // texto
  ctx.fillStyle="rgba(0,0,0,0.80)";
  ctx.font="700 20px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("MÓBILES — suiornotsui", pad, 50);

  ctx.fillStyle="rgba(0,0,0,0.55)";
  ctx.font="14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(nowISO(), pad, 72);

  ctx.fillStyle="rgba(0,0,0,0.70)";
  ctx.font="16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const text = configToText(cfg);
  const lines = text.split("\n").slice(0,6);
  let ty = dy + targetH + 46;
  for(const ln of lines){
    ctx.fillText(ln, pad, ty);
    ty += 22;
  }

  return out;
}
async function canvasToPngFile(canvas, filename){
  return new Promise((resolve)=>{
    canvas.toBlob((blob)=>{
      resolve({ file: new File([blob], filename, {type:"image/png"}), blob });
    }, "image/png");
  });
}

const ShareUI = (function(){
  const dlg = document.getElementById("shareDlg");
  const title = document.getElementById("shareTitle");
  const note = document.getElementById("shareNote");
  const textBox = document.getElementById("shareText");
  const btnCopy = document.getElementById("copyText");
  const btnDl = document.getElementById("downloadImg");
  const btnShare = document.getElementById("nativeShare");
  const btnClose = document.getElementById("closeDlg");

  let payload = null;

  btnClose.onclick = ()=> dlg.close();
  btnCopy.onclick = async ()=>{
    if(!payload) return;
    await navigator.clipboard.writeText(payload.text);
  };
  btnDl.onclick = ()=>{
    if(!payload) return;
    const a = document.createElement("a");
    a.download = payload.filename;
    a.href = payload.outCanvas.toDataURL("image/png");
    a.click();
  };
  btnShare.onclick = async ()=>{
    if(!payload) return;
    try{
      if(navigator.share){
        if(navigator.canShare && navigator.canShare({ files:[payload.file] })){
          await navigator.share({ title:"MÓBILES", text: payload.text, files:[payload.file] });
        }else{
          await navigator.share({ title:"MÓBILES", text: payload.text });
        }
      }
    }catch(e){}
  };

  function open({label, text, outCanvas, file, filename, canNativeFileShare}){
    payload = {label, text, outCanvas, file, filename};
    title.textContent = label;
    textBox.textContent = text;
    note.textContent = navigator.share
      ? (canNativeFileShare ? "Partilha nativa: imagem + texto disponíveis." : "Partilha nativa pode limitar anexos; fallback: baixar imagem / copiar texto.")
      : "Este navegador não oferece partilha nativa. Use baixar imagem + copiar texto.";
    btnShare.style.display = navigator.share ? "inline-flex" : "none";
    dlg.showModal();
  }
  return { open };
})();

async function shareMobile(mKey){
  const cfg = (mKey==="final") ? Mobiles.final.config : Mobiles[mKey].config;
  const canvas = document.getElementById(mKey==="final" ? "finalCanvas" : (mKey+"Canvas"));
  if(!cfg || !canvas) return;

  const text = configToText(cfg) + "\n\n" +
    "Faz a tua curadoria aqui: " + (BASE_MOBILES + "entrada/");

  const out = exportCompositePNG(canvas, cfg);
  const filename = `mobiles_${mKey}_${Date.now()}.png`;
  const { file } = await canvasToPngFile(out, filename);
  const canNativeFileShare = !!(navigator.canShare && navigator.canShare({ files:[file] }));

  if(navigator.share){
    try{
      if(canNativeFileShare){
        await navigator.share({ title:"MÓBILES", text, files:[file] });
        return;
      }else{
        await navigator.share({ title:"MÓBILES", text });
      }
    }catch(e){}
  }

  ShareUI.open({
    label: (mKey==="final") ? "Partilhar estado alcançado" : `Partilhar ${mKey.toUpperCase()}`,
    text, outCanvas: out, file, filename, canNativeFileShare
  });
}

/* =======================================================
   12) Chips fonográficos (CORRIGIDO: sem syntax error!)
======================================================= */
function initChips(){
  const box = document.getElementById("m4Chips");
  box.innerHTML = "";
  for(const p of PHONO_PRESETS){
    const el = document.createElement("span");
    el.className = "chip";
    el.textContent = p.label;

    el.onclick = ()=>{
      const on = (PHONO.mode === p.key);
      PHONO.mode = on ? "neutro" : p.key;

      // ✅ CORREÇÃO CRÍTICA (era {.p.vec})
      PHONO.vector = on ? {dry:0,voiced:0,open:0} : { ...p.vec };

      // inclina campo pelo modo fonográfico
      applyDelta("m4", {
        cont: -0.20*PHONO.vector.dry + 0.15*PHONO.vector.open,
        dense: 0.10*PHONO.vector.voiced,
        front: 0.05*(PHONO.vector.voiced - PHONO.vector.dry),
        pressure: 0.25,
      });

      renderChipsState();
      rerenderAll();
    };
    box.appendChild(el);
  }
  renderChipsState();
}
function renderChipsState(){
  const chips = Array.from(document.querySelectorAll("#m4Chips .chip"));
  chips.forEach((c,i)=>{
    const key = PHONO_PRESETS[i].key;
    c.classList.toggle("on", PHONO.mode===key);
  });
}

/* =======================================================
   13) Botões (M3/M4/FINAL voltam porque JS não quebra)
======================================================= */
function initButtons(){
  document.getElementById("btnReset").onclick = ()=>{
    resetAll();
    rerenderAll();
  };

  document.getElementById("m1Tension").onclick = ()=>{
    applyDelta("m1", {
      front:rnd(-0.45,0.55),
      dense:rnd(-0.35,0.45),
      cont:rnd(-0.55,0.55),
      pressure:0.35
    });
    rerenderAll();
  };

  document.getElementById("m2Swap").onclick = ()=>{
    Mobiles.m2.flip = !Mobiles.m2.flip;
    applyDelta("m2", { front: Mobiles.m2.flip ? -0.55 : +0.55, cont: 0.10, pressure:0.18 });
    rerenderAll();
  };

  document.getElementById("btnFinalize").onclick = ()=>{
    renderFinal();
  };

  document.getElementById("m1Share").onclick = ()=> shareMobile("m1");
  document.getElementById("m2Share").onclick = ()=> shareMobile("m2");
  document.getElementById("m3Share").onclick = ()=> shareMobile("m3");
  document.getElementById("m4Share").onclick = ()=> shareMobile("m4");
  document.getElementById("finalShare").onclick = ()=> shareMobile("final");
}

/* =======================================================
   14) Boot
======================================================= */
(async function boot(){
  buildField();
  await tryLoadSui();
  resetAll();
  initChips();
  initButtons();
  rerenderAll();
})();
</script>
</body>
</html>
